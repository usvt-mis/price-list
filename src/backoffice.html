<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Backoffice Admin</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üîê</text></svg>"/>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-6xl mx-auto p-6 space-y-6">

    <!-- Backoffice Login View -->
    <div id="backofficeLoginView">
      <div class="flex items-center justify-center min-h-[60vh]">
        <div class="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full mx-4">
          <!-- Logo/Icon -->
          <div class="text-center mb-6">
            <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
              </svg>
            </div>
            <h1 class="text-2xl font-bold text-slate-900">Backoffice Admin</h1>
            <p class="text-sm text-slate-500 mt-1">Sign in to manage user roles</p>
          </div>

          <!-- Login Form -->
          <form id="backofficeLoginForm" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">Username</label>
              <input id="backofficeUsername" type="text" required
                class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                placeholder="Enter your username">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">Password</label>
              <input id="backofficePassword" type="password" required
                class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                placeholder="Enter your password">
            </div>
            <div id="backofficeLoginError" class="hidden text-sm text-red-600 bg-red-50 rounded-lg p-3"></div>
            <button type="submit" id="backofficeLoginSubmitBtn"
              class="w-full px-4 py-3 rounded-lg bg-purple-600 text-white font-medium hover:bg-purple-700 transition-colors flex items-center justify-center gap-2">
              <span>Sign In</span>
            </button>
          </form>

          <!-- Version Footer -->
          <div class="mt-6 pt-4 border-t border-slate-200 text-center">
            <p class="text-xs text-slate-500">Backoffice v<span id="appVersion">loading...</span></p>
          </div>
        </div>
      </div>
    </div>

    <!-- Backoffice Dashboard View (hidden by default) -->
    <div id="backofficeDashboardView" class="hidden">
      <div class="bg-white rounded-2xl shadow p-6">
        <div class="flex items-center justify-between mb-6">
          <div>
            <h1 class="text-2xl font-bold text-slate-900">Backoffice Dashboard</h1>
            <p class="text-sm text-slate-500">Manage user role assignments</p>
          </div>
          <div class="flex items-center gap-3">
            <span id="backofficeAdminName" class="text-sm text-slate-600"></span>
            <button id="backofficeLogoutBtn" class="px-4 py-2 text-sm rounded-lg border border-slate-200 hover:bg-slate-50 transition-colors">
              Logout
            </button>
          </div>
        </div>

        <!-- Tabs -->
        <div class="flex items-center gap-1 bg-slate-100 rounded-lg p-1 mb-6 overflow-x-auto">
          <button onclick="showBackofficeTab('executives')" id="backofficeTabExecutives" class="px-4 py-2 text-sm font-medium rounded-md transition-colors whitespace-nowrap">
            Executives <span id="executiveCount" class="ml-1 px-2 py-0.5 text-xs bg-purple-200 text-purple-700 rounded-full">0</span>
          </button>
          <button onclick="showBackofficeTab('sales')" id="backofficeTabSales" class="px-4 py-2 text-sm font-medium rounded-md transition-colors whitespace-nowrap">
            Sales <span id="salesCount" class="ml-1 px-2 py-0.5 text-xs bg-blue-200 text-blue-700 rounded-full">0</span>
          </button>
          <button onclick="showBackofficeTab('customers')" id="backofficeTabCustomers" class="px-4 py-2 text-sm font-medium rounded-md transition-colors whitespace-nowrap">
            Customers <span id="customerCount" class="ml-1 px-2 py-0.5 text-xs bg-gray-200 text-gray-700 rounded-full">0</span>
          </button>
          <button onclick="showBackofficeTab('audit')" id="backofficeTabAudit" class="px-4 py-2 text-sm font-medium rounded-md transition-colors whitespace-nowrap">
            Audit Log
          </button>
        </div>

        <!-- Executives Tab -->
        <div id="backofficeExecutivesTab" class="hidden">
          <!-- Inline Add Form -->
          <div class="flex flex-col sm:flex-row gap-3 mb-6 p-4 bg-purple-50 rounded-lg border border-purple-200">
            <div class="flex-1">
              <input id="executiveEmailInput" type="email" placeholder="Enter email to add to Executives..."
                class="w-full px-4 py-2 rounded-lg border border-purple-300 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
            </div>
            <div class="flex items-center gap-2">
              <span id="executiveValidation" class="text-sm"></span>
              <button id="executiveAddBtn" class="px-4 py-2 rounded-lg bg-purple-600 text-white text-sm hover:bg-purple-700 transition-colors">
                Add
              </button>
            </div>
          </div>

          <!-- Search -->
          <div class="flex flex-col sm:flex-row gap-4 mb-6">
            <div class="flex-1">
              <input id="executiveSearch" type="text" placeholder="Search Executives by email..."
                class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
            </div>
            <button id="executiveSearchBtn" class="px-4 py-2 rounded-lg bg-slate-900 text-white text-sm hover:bg-slate-800 transition-colors">
              Search
            </button>
          </div>

          <!-- Users Table -->
          <div class="border border-slate-200 rounded-lg overflow-hidden">
            <table class="w-full text-sm">
              <thead class="bg-slate-50 text-slate-600">
                <tr>
                  <th class="text-left px-4 py-3 font-medium">Email</th>
                  <th class="text-left px-4 py-3 font-medium">Status</th>
                  <th class="text-left px-4 py-3 font-medium">Assigned By</th>
                  <th class="text-left px-4 py-3 font-medium">Last Login</th>
                  <th class="text-left px-4 py-3 font-medium">Actions</th>
                </tr>
              </thead>
              <tbody id="executiveUsersList" class="divide-y divide-slate-100">
                <tr>
                  <td colspan="5" class="px-4 py-8 text-center text-slate-500">Loading Executives...</td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          <div id="executivePagination" class="flex items-center justify-between mt-4">
            <span id="executivePaginationInfo" class="text-sm text-slate-600"></span>
            <div class="flex items-center gap-2">
              <button id="executivePrevPage" class="px-3 py-1 rounded border border-slate-200 text-sm hover:bg-slate-50 disabled:opacity-50" disabled>
                Previous
              </button>
              <button id="executiveNextPage" class="px-3 py-1 rounded border border-slate-200 text-sm hover:bg-slate-50 disabled:opacity-50" disabled>
                Next
              </button>
            </div>
          </div>
        </div>

        <!-- Sales Tab -->
        <div id="backofficeSalesTab" class="hidden">
          <!-- Inline Add Form -->
          <div class="flex flex-col sm:flex-row gap-3 mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
            <div class="flex-1">
              <input id="salesEmailInput" type="email" placeholder="Enter email to add to Sales..."
                class="w-full px-4 py-2 rounded-lg border border-blue-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            <div class="flex items-center gap-2">
              <span id="salesValidation" class="text-sm"></span>
              <button id="salesAddBtn" class="px-4 py-2 rounded-lg bg-blue-600 text-white text-sm hover:bg-blue-700 transition-colors">
                Add
              </button>
            </div>
          </div>

          <!-- Search -->
          <div class="flex flex-col sm:flex-row gap-4 mb-6">
            <div class="flex-1">
              <input id="salesSearch" type="text" placeholder="Search Sales by email..."
                class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            <button id="salesSearchBtn" class="px-4 py-2 rounded-lg bg-slate-900 text-white text-sm hover:bg-slate-800 transition-colors">
              Search
            </button>
          </div>

          <!-- Users Table -->
          <div class="border border-slate-200 rounded-lg overflow-hidden">
            <table class="w-full text-sm">
              <thead class="bg-slate-50 text-slate-600">
                <tr>
                  <th class="text-left px-4 py-3 font-medium">Email</th>
                  <th class="text-left px-4 py-3 font-medium">Status</th>
                  <th class="text-left px-4 py-3 font-medium">Assigned By</th>
                  <th class="text-left px-4 py-3 font-medium">Last Login</th>
                  <th class="text-left px-4 py-3 font-medium">Actions</th>
                </tr>
              </thead>
              <tbody id="salesUsersList" class="divide-y divide-slate-100">
                <tr>
                  <td colspan="5" class="px-4 py-8 text-center text-slate-500">Loading Sales...</td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          <div id="salesPagination" class="flex items-center justify-between mt-4">
            <span id="salesPaginationInfo" class="text-sm text-slate-600"></span>
            <div class="flex items-center gap-2">
              <button id="salesPrevPage" class="px-3 py-1 rounded border border-slate-200 text-sm hover:bg-slate-50 disabled:opacity-50" disabled>
                Previous
              </button>
              <button id="salesNextPage" class="px-3 py-1 rounded border border-slate-200 text-sm hover:bg-slate-50 disabled:opacity-50" disabled>
                Next
              </button>
            </div>
          </div>
        </div>

        <!-- Customers Tab -->
        <div id="backofficeCustomersTab" class="hidden">
          <!-- Info Banner -->
          <div class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
            <p class="text-sm text-gray-600">
              <strong>Customers</strong> are pre-registered users who can only view calculations shared via link. They do not have login access.
            </p>
          </div>

          <!-- Inline Add Form -->
          <div class="flex flex-col sm:flex-row gap-3 mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
            <div class="flex-1">
              <input id="customerEmailInput" type="email" placeholder="Enter email to add to Customers..."
                class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:border-transparent">
            </div>
            <div class="flex items-center gap-2">
              <span id="customerValidation" class="text-sm"></span>
              <button id="customerAddBtn" class="px-4 py-2 rounded-lg bg-gray-600 text-white text-sm hover:bg-gray-700 transition-colors">
                Add
              </button>
            </div>
          </div>

          <!-- Search -->
          <div class="flex flex-col sm:flex-row gap-4 mb-6">
            <div class="flex-1">
              <input id="customerSearch" type="text" placeholder="Search Customers by email..."
                class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:border-transparent">
            </div>
            <button id="customerSearchBtn" class="px-4 py-2 rounded-lg bg-slate-900 text-white text-sm hover:bg-slate-800 transition-colors">
              Search
            </button>
          </div>

          <!-- Users Table -->
          <div class="border border-slate-200 rounded-lg overflow-hidden">
            <table class="w-full text-sm">
              <thead class="bg-slate-50 text-slate-600">
                <tr>
                  <th class="text-left px-4 py-3 font-medium">Email</th>
                  <th class="text-left px-4 py-3 font-medium">Status</th>
                  <th class="text-left px-4 py-3 font-medium">Assigned By</th>
                  <th class="text-left px-4 py-3 font-medium">Assigned At</th>
                  <th class="text-left px-4 py-3 font-medium">Actions</th>
                </tr>
              </thead>
              <tbody id="customerUsersList" class="divide-y divide-slate-100">
                <tr>
                  <td colspan="5" class="px-4 py-8 text-center text-slate-500">Loading Customers...</td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          <div id="customerPagination" class="flex items-center justify-between mt-4">
            <span id="customerPaginationInfo" class="text-sm text-slate-600"></span>
            <div class="flex items-center gap-2">
              <button id="customerPrevPage" class="px-3 py-1 rounded border border-slate-200 text-sm hover:bg-slate-50 disabled:opacity-50" disabled>
                Previous
              </button>
              <button id="customerNextPage" class="px-3 py-1 rounded border border-slate-200 text-sm hover:bg-slate-50 disabled:opacity-50" disabled>
                Next
              </button>
            </div>
          </div>
        </div>

        <!-- Audit Log Tab -->
        <div id="backofficeAuditTab" class="hidden">
          <!-- Search -->
          <div class="flex flex-col sm:flex-row gap-4 mb-6">
            <div class="flex-1">
              <input id="auditSearch" type="text" placeholder="Search audit log by email..."
                class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
            </div>
            <button id="auditSearchBtn" class="px-4 py-2 rounded-lg bg-slate-900 text-white text-sm hover:bg-slate-800 transition-colors">
              Search
            </button>
          </div>

          <!-- Audit Table -->
          <div class="border border-slate-200 rounded-lg overflow-hidden">
            <table class="w-full text-sm">
              <thead class="bg-slate-50 text-slate-600">
                <tr>
                  <th class="text-left px-4 py-3 font-medium">Target Email</th>
                  <th class="text-left px-4 py-3 font-medium">Old Role</th>
                  <th class="text-left px-4 py-3 font-medium">New Role</th>
                  <th class="text-left px-4 py-3 font-medium">Changed By</th>
                  <th class="text-left px-4 py-3 font-medium">Changed At</th>
                </tr>
              </thead>
              <tbody id="backofficeAuditList" class="divide-y divide-slate-100">
                <tr>
                  <td colspan="5" class="px-4 py-8 text-center text-slate-500">Loading audit log...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Role Change Modal (hidden by default) -->
    <div id="roleChangeModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 backdrop-blur-sm">
      <div class="bg-white rounded-2xl shadow-xl p-6 max-w-sm w-full mx-4">
        <h3 class="text-xl font-bold text-slate-900 mb-4">Change Role</h3>
        <p class="text-sm text-slate-600 mb-4">Select new role for <strong id="roleChangeEmail"></strong>:</p>

        <div class="space-y-3 mb-6">
          <label class="flex items-center gap-3 p-3 rounded-lg border border-slate-200 hover:bg-slate-50 cursor-pointer">
            <input type="radio" name="roleChange" value="NoRole" class="text-purple-600">
            <div>
              <div class="font-medium text-slate-900">Unassigned</div>
              <div class="text-xs text-slate-500">No access - "Awaiting Assignment"</div>
            </div>
          </label>
          <label class="flex items-center gap-3 p-3 rounded-lg border border-slate-200 hover:bg-slate-50 cursor-pointer">
            <input type="radio" name="roleChange" value="Sales" class="text-blue-600">
            <div>
              <div class="font-medium text-slate-900">Sales</div>
              <div class="text-xs text-slate-500">Can view and save calculations</div>
            </div>
          </label>
          <label class="flex items-center gap-3 p-3 rounded-lg border border-slate-200 hover:bg-slate-50 cursor-pointer">
            <input type="radio" name="roleChange" value="Executive" class="text-emerald-600">
            <div>
              <div class="font-medium text-slate-900">Executive</div>
              <div class="text-xs text-slate-500">Full access including admin features</div>
            </div>
          </label>
          <label class="flex items-center gap-3 p-3 rounded-lg border border-slate-200 hover:bg-slate-50 cursor-pointer">
            <input type="radio" name="roleChange" value="Customer" class="text-gray-600">
            <div>
              <div class="font-medium text-slate-900">Customer</div>
              <div class="text-xs text-slate-500">Pre-registered for shared links only</div>
            </div>
          </label>
        </div>

        <div class="flex gap-3">
          <button id="roleChangeCancel" class="flex-1 px-4 py-2 rounded-lg border border-slate-200 text-slate-700 hover:bg-slate-50 transition-colors">
            Cancel
          </button>
          <button id="roleChangeConfirm" class="flex-1 px-4 py-2 rounded-lg bg-purple-600 text-white hover:bg-purple-700 transition-colors">
            Change Role
          </button>
        </div>
      </div>
    </div>

    <!-- Notification Toast (hidden by default) -->
    <div id="notificationToast" class="hidden fixed bottom-6 right-6 z-50 px-6 py-4 rounded-lg shadow-lg text-sm font-medium transition-all transform">
      <span id="notificationMessage"></span>
    </div>

  </div>

<script>
  // ---------- Version Display ----------
  // Fetch and display version from API (reads from package.json)
  async function loadVersion() {
    try {
      const response = await fetch('/api/version');
      if (response.ok) {
        const data = await response.json();
        const versionEl = el('appVersion');
        if (versionEl) {
          versionEl.textContent = data.version;
        }
      }
    } catch (error) {
      console.debug('Failed to fetch version:', error);
    }
  }

  // Load version on page load
  loadVersion();

  // ---------- Utility Functions ----------

  // Helper to get element by ID
  function el(id) {
    return document.getElementById(id);
  }

  // Show notification toast
  function showNotification(message, type = 'success') {
    const toast = el('notificationToast');
    const messageEl = el('notificationMessage');

    messageEl.textContent = message;

    // Set styles based on type
    toast.className = `fixed bottom-6 right-6 z-50 px-6 py-4 rounded-lg shadow-lg text-sm font-medium transition-all transform ${
      type === 'success'
        ? 'bg-emerald-600 text-white'
        : type === 'error'
        ? 'bg-red-600 text-white'
        : 'bg-slate-800 text-white'
    }`;

    toast.classList.remove('hidden');

    // Auto-hide after 3 seconds
    setTimeout(() => {
      toast.classList.add('hidden');
    }, 3000);
  }

  // Show view helper
  function showView(view) {
    // Hide all views
    el('backofficeLoginView').classList.add('hidden');
    el('backofficeDashboardView').classList.add('hidden');

    // Show requested view
    if (view === 'backoffice-login') {
      el('backofficeLoginView').classList.remove('hidden');
    } else if (view === 'backoffice-dashboard') {
      el('backofficeDashboardView').classList.remove('hidden');
    }
  }

  // ---------- Backoffice Auth and Dashboard ----------

  // Backoffice auth state
  let backofficeState = {
    isAuthenticated: false,
    isInitializing: false,  // Prevents race condition during login
    admin: null,
    token: null,
    tokenExpiresAt: null,
    currentTab: 'executives', // Default tab changed to 'executives'
    currentPage: 1,
    pageSize: 50,
    totalPages: 0,
    currentEmail: null,
    lastActivity: Date.now(),
    idleCheckInterval: null,
    // Track page for each tab
    tabPages: {
      executives: 1,
      sales: 1,
      customers: 1
    },
    // Track existing users for duplicate detection
    tabUsers: {
      executives: [],
      sales: [],
      customers: []
    },
    // Track counts for badges
    roleCounts: {
      executive: 0,
      sales: 0,
      customer: 0
    }
  };

  // Session timeout duration (8 hours of inactivity - matches token expiry)
  const IDLE_TIMEOUT = 8 * 60 * 60 * 1000;

  // Reset activity timer on user interaction
  function resetActivityTimer() {
    if (backofficeState.isAuthenticated) {
      backofficeState.lastActivity = Date.now();
    }
  }

  // Track user activity for idle timeout
  document.addEventListener('click', resetActivityTimer);
  document.addEventListener('keypress', resetActivityTimer);
  document.addEventListener('scroll', resetActivityTimer);
  document.addEventListener('touchstart', resetActivityTimer);

  // Check for idle timeout
  function checkIdleTimeout() {
    if (!backofficeState.isAuthenticated) return;

    const inactiveTime = Date.now() - backofficeState.lastActivity;
    if (inactiveTime > IDLE_TIMEOUT) {
      // Session expired due to inactivity
      backofficeLogout();
      showNotification('Session expired due to inactivity');
    }
  }

  // Start idle timeout check
  function startIdleTimeoutCheck() {
    if (backofficeState.idleCheckInterval) {
      clearInterval(backofficeState.idleCheckInterval);
    }
    backofficeState.idleCheckInterval = setInterval(checkIdleTimeout, 60000); // Check every minute
  }

  // Stop idle timeout check
  function stopIdleTimeoutCheck() {
    if (backofficeState.idleCheckInterval) {
      clearInterval(backofficeState.idleCheckInterval);
      backofficeState.idleCheckInterval = null;
    }
  }

  // Check for backoffice session on page load
  function checkBackofficeSession() {
    // Skip session check during initialization (prevents race condition)
    if (backofficeState.isInitializing) {
      console.log('[BACKOFFICE SESSION] Skipping check during initialization');
      return true;
    }

    const token = sessionStorage.getItem('backofficeToken');
    const admin = JSON.parse(sessionStorage.getItem('backofficeAdmin') || 'null');
    const tokenExpiresAt = sessionStorage.getItem('backofficeTokenExpiresAt');

    // Add diagnostic logging
    console.log('[BACKOFFICE SESSION] Checking session:', {
      hasToken: !!token,
      hasAdmin: !!admin,
      hasExpiry: !!tokenExpiresAt,
      expiryDate: tokenExpiresAt ? new Date(tokenExpiresAt).toISOString() : null,
      isExpired: tokenExpiresAt ? Date.now() >= new Date(tokenExpiresAt).getTime() : null,
      currentTime: new Date().toISOString()
    });

    if (token && admin && tokenExpiresAt) {
      // Check if token has expired
      let expiryDate = new Date(tokenExpiresAt);

      // Try to parse JWT to get exact expiry (more reliable than stored value)
      try {
        const tokenPayload = JSON.parse(atob(token.split('.')[1]));
        const jwtExpiry = new Date(tokenPayload.exp * 1000);
        // Use JWT expiry if it's different from stored expiry
        if (Math.abs(jwtExpiry.getTime() - expiryDate.getTime()) > 1000) {
          console.log('[BACKOFFICE SESSION] Using JWT expiry instead of stored value:', {
            stored: expiryDate.toISOString(),
            jwt: jwtExpiry.toISOString()
          });
          expiryDate = jwtExpiry;
        }
      } catch (e) {
        console.warn('[BACKOFFICE SESSION] Failed to parse JWT, using stored expiry:', e);
      }

      const currentTime = Date.now();

      if (currentTime < expiryDate.getTime()) {
        // Token is still valid
        backofficeState.isAuthenticated = true;
        backofficeState.admin = admin;
        backofficeState.token = token;
        backofficeState.tokenExpiresAt = expiryDate;
        backofficeState.lastActivity = currentTime;
        startIdleTimeoutCheck();
        console.log('[BACKOFFICE SESSION] Session is valid');
        return true;
      } else {
        // Token expired - clear sessionStorage
        console.log('[BACKOFFICE SESSION] Token expired, clearing session');
        sessionStorage.removeItem('backofficeToken');
        sessionStorage.removeItem('backofficeAdmin');
        sessionStorage.removeItem('backofficeTokenExpiresAt');
      }
    }

    console.log('[BACKOFFICE SESSION] No valid session found');
    return false;
  }

  // Check if token is still valid (lightweight check without backend call)
  function isTokenValid() {
    if (!backofficeState.tokenExpiresAt) {
      console.log('[BACKOFFICE TOKEN] No expiry date set');
      return false;
    }
    const isValid = Date.now() < new Date(backofficeState.tokenExpiresAt).getTime();
    console.log('[BACKOFFICE TOKEN] Token validity check:', {
      expiresAt: backofficeState.tokenExpiresAt.toISOString(),
      currentTime: new Date().toISOString(),
      isValid: isValid
    });
    return isValid;
  }

  // Backoffice login form handler
  el('backofficeLoginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const username = el('backofficeUsername').value.trim();
    const password = el('backofficePassword').value;
    const errorEl = el('backofficeLoginError');
    const submitBtn = el('backofficeLoginSubmitBtn');

    // Clear previous error
    errorEl.classList.add('hidden');

    // Disable submit button
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="animate-spin">‚åõ</span> Signing in...';

    try {
      const response = await fetch('/api/backoffice/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });

      const data = await response.json();

      if (response.ok) {
        // Set session state BEFORE navigation
        backofficeState.isAuthenticated = true;
        backofficeState.admin = data.admin;
        backofficeState.token = data.accessToken;
        backofficeState.lastActivity = Date.now();

        // Parse JWT to get exact expiry timestamp from exp claim
        let tokenExpiresAt;
        try {
          const tokenPayload = JSON.parse(atob(data.accessToken.split('.')[1]));
          tokenExpiresAt = new Date(tokenPayload.exp * 1000);
          console.log('[BACKOFFICE LOGIN] Token expiry from JWT:', tokenExpiresAt.toISOString());
        } catch (e) {
          console.warn('[BACKOFFICE LOGIN] Failed to parse JWT, using fallback calculation:', e);
          // Fallback to calculation from expiresIn if JWT parsing fails
          tokenExpiresAt = new Date(Date.now() + data.expiresIn * 1000);
        }
        backofficeState.tokenExpiresAt = tokenExpiresAt;

        // Store in sessionStorage
        sessionStorage.setItem('backofficeToken', data.accessToken);
        sessionStorage.setItem('backofficeAdmin', JSON.stringify(data.admin));
        sessionStorage.setItem('backofficeTokenExpiresAt', tokenExpiresAt.toISOString());

        // Set initialization flag to prevent race condition
        backofficeState.isInitializing = true;

        // Start idle timeout check
        startIdleTimeoutCheck();

        // Navigate to dashboard - let hash change handler handle navigation
        // This prevents race condition from double dashboard call
        window.location.hash = '#dashboard';

        // Clear initialization flag after navigation completes
        setTimeout(() => {
          backofficeState.isInitializing = false;
          console.log('[BACKOFFICE LOGIN] Initialization complete');
        }, 100);
      } else {
        // Show error
        errorEl.textContent = data.error || 'Login failed';
        errorEl.classList.remove('hidden');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<span>Sign In</span>';
      }
    } catch (error) {
      console.error('Backoffice login error:', error);
      errorEl.textContent = 'Network error. Please try again.';
      errorEl.classList.remove('hidden');
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<span>Sign In</span>';
    }
  });

  // Backoffice logout handler
  async function backofficeLogout() {
    try {
      await fetch('/api/backoffice/logout', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${backofficeState.token}`
        }
      });
    } catch (e) {
      console.error('Logout error:', e);
    }

    // Stop idle timeout check
    stopIdleTimeoutCheck();

    // Clear session
    sessionStorage.removeItem('backofficeToken');
    sessionStorage.removeItem('backofficeAdmin');
    sessionStorage.removeItem('backofficeTokenExpiresAt');
    backofficeState = {
      isAuthenticated: false,
      isInitializing: false,  // Reset initialization flag on logout
      admin: null,
      token: null,
      tokenExpiresAt: null,
      currentTab: 'executives', // Changed from 'users'
      currentPage: 1,
      pageSize: 50,
      totalPages: 0,
      currentEmail: null,
      lastActivity: Date.now(),
      idleCheckInterval: null,
      tabPages: {
        executives: 1,
        sales: 1,
        customers: 1
      },
      tabUsers: {
        executives: [],
        sales: [],
        customers: []
      },
      roleCounts: {
        executive: 0,
        sales: 0,
        customer: 0
      }
    };

    // Reset login button state (if showing login form)
    const submitBtn = el('backofficeLoginSubmitBtn');
    if (submitBtn) {
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<span>Sign In</span>';
    }

    // Navigate to login
    window.location.hash = '#login';
    showView('backoffice-login');
  }

  el('backofficeLogoutBtn').addEventListener('click', backofficeLogout);

  // Show backoffice dashboard
  function showBackofficeDashboard() {
    if (!backofficeState.isAuthenticated) {
      showView('backoffice-login');
      return;
    }

    // Update admin name
    if (el('backofficeAdminName')) {
      el('backofficeAdminName').textContent = `Logged in as ${backofficeState.admin.username}`;
    }

    showView('backoffice-dashboard');
    showBackofficeTab('executives'); // Changed from 'users' to 'executives'
  }

  // Show backoffice tab (executives, sales, customers, or audit)
  window.showBackofficeTab = function(tab) {
    backofficeState.currentTab = tab;

    // Reset all tab button styles
    const tabButtons = ['backofficeTabExecutives', 'backofficeTabSales', 'backofficeTabCustomers', 'backofficeTabAudit'];
    tabButtons.forEach(btnId => {
      if (el(btnId)) {
        el(btnId).classList.remove('bg-white', 'shadow-sm', 'text-purple-600');
        el(btnId).classList.add('text-slate-600', 'hover:text-slate-900');
      }
    });

    // Hide all tab contents
    const tabContents = ['backofficeExecutivesTab', 'backofficeSalesTab', 'backofficeCustomersTab', 'backofficeAuditTab'];
    tabContents.forEach(contentId => {
      if (el(contentId)) {
        el(contentId).classList.add('hidden');
      }
    });

    // Show selected tab
    if (tab === 'executives') {
      if (el('backofficeTabExecutives')) {
        el('backofficeTabExecutives').classList.add('bg-white', 'shadow-sm', 'text-purple-600');
        el('backofficeTabExecutives').classList.remove('text-slate-600', 'hover:text-slate-900');
      }
      if (el('backofficeExecutivesTab')) {
        el('backofficeExecutivesTab').classList.remove('hidden');
      }
      loadRoleTabUsers('Executive', 'executive');
    } else if (tab === 'sales') {
      if (el('backofficeTabSales')) {
        el('backofficeTabSales').classList.add('bg-white', 'shadow-sm', 'text-blue-600');
        el('backofficeTabSales').classList.remove('text-slate-600', 'hover:text-slate-900');
      }
      if (el('backofficeSalesTab')) {
        el('backofficeSalesTab').classList.remove('hidden');
      }
      loadRoleTabUsers('Sales', 'sales');
    } else if (tab === 'customers') {
      if (el('backofficeTabCustomers')) {
        el('backofficeTabCustomers').classList.add('bg-white', 'shadow-sm', 'text-gray-600');
        el('backofficeTabCustomers').classList.remove('text-slate-600', 'hover:text-slate-900');
      }
      if (el('backofficeCustomersTab')) {
        el('backofficeCustomersTab').classList.remove('hidden');
      }
      loadRoleTabUsers('Customer', 'customer');
    } else if (tab === 'audit') {
      if (el('backofficeTabAudit')) {
        el('backofficeTabAudit').classList.add('bg-white', 'shadow-sm', 'text-purple-600');
        el('backofficeTabAudit').classList.remove('text-slate-600', 'hover:text-slate-900');
      }
      if (el('backofficeAuditTab')) {
        el('backofficeAuditTab').classList.remove('hidden');
      }
      loadBackofficeAuditLog();
    }
  };

  // Load users for a specific role tab
  async function loadRoleTabUsers(role, tabSuffix, page = null) {
    // Use saved page for this tab if not provided
    if (page === null) {
      page = backofficeState.tabPages[tabSuffix] || 1;
    }
    backofficeState.tabPages[tabSuffix] = page;

    const searchInput = el(`${tabSuffix}Search`);
    const search = searchInput?.value || '';
    const pageSize = backofficeState.pageSize;

    try {
      const url = new URL('/api/backoffice/users', window.location.origin);
      url.searchParams.set('page', page);
      url.searchParams.set('pageSize', pageSize);
      url.searchParams.set('role', role); // Filter by role
      if (search) url.searchParams.set('search', search);

      const response = await fetch(url.toString(), {
        headers: {
          'Authorization': `Bearer ${backofficeState.token}`
        }
      });

      if (!response.ok) {
        if (response.status === 401) {
          const submitBtn = el('backofficeLoginSubmitBtn');
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<span>Sign In</span>';
          }
          backofficeLogout();
          showNotification('Session expired. Please log in again.');
          return;
        }
        throw new Error(`Failed to load ${role} users`);
      }

      const data = await response.json();
      backofficeState.tabPages[tabSuffix] = page;
      backofficeState.tabUsers[tabSuffix] = data.users;

      // Update count badge
      const countBadge = el(`${tabSuffix}Count`);
      if (countBadge) {
        countBadge.textContent = data.pagination.total;
      }

      renderRoleTabUsers(data.users, tabSuffix, role);
      updateRoleTabPagination(data.pagination, tabSuffix);
    } catch (error) {
      console.error(`Failed to load ${role} users:`, error);
      const listId = `${tabSuffix}UsersList`;
      const container = el(listId);
      if (container) {
        container.innerHTML = `
          <tr>
            <td colspan="5" class="px-4 py-8 text-center text-red-500">
              Failed to load users. ${error.message}
            </td>
          </tr>
        `;
      }
    }
  }

  // Render users for a role tab
  function renderRoleTabUsers(users, tabSuffix, role) {
    const container = el(`${tabSuffix}UsersList`);
    if (!container) return;

    if (users.length === 0) {
      container.innerHTML = `
        <tr>
          <td colspan="5" class="px-4 py-8 text-center text-slate-500">
            No ${role.toLowerCase()} users found.
          </td>
        </tr>
      `;
      return;
    }

    container.innerHTML = users.map(user => {
      const isActive = user.lastLoginAt !== null;
      const lastLoginText = user.lastLoginAt
        ? timeAgo(new Date(user.lastLoginAt))
        : 'Never';

      return `
        <tr class="hover:bg-slate-50">
          <td class="px-4 py-3 font-medium">${user.email}</td>
          <td class="px-4 py-3">
            <span class="px-2 py-1 text-xs font-semibold rounded ${
              isActive
                ? 'bg-green-100 text-green-700'
                : 'bg-gray-100 text-gray-600'
            }">
              ${isActive ? 'Active' : 'Pending'}
            </span>
          </td>
          <td class="px-4 py-3 text-slate-600">${user.assignedBy || 'System'}</td>
          <td class="px-4 py-3 text-slate-600">${lastLoginText}</td>
          <td class="px-4 py-3">
            <button onclick="openRoleChangeModal('${user.email}', '${user.role}')" class="px-3 py-1 text-xs font-medium rounded border border-purple-200 text-purple-700 hover:bg-purple-50 transition-colors">
              Change
            </button>
          </td>
        </tr>
      `;
    }).join('');
  }

  // Update pagination for a role tab
  function updateRoleTabPagination(pagination, tabSuffix) {
    const infoEl = el(`${tabSuffix}PaginationInfo`);
    const prevBtn = el(`${tabSuffix}PrevPage`);
    const nextBtn = el(`${tabSuffix}NextPage`);

    if (infoEl) {
      infoEl.textContent = `Page ${pagination.page} of ${pagination.totalPages} (${pagination.total} total)`;
    }
    if (prevBtn) {
      prevBtn.disabled = pagination.page <= 1;
    }
    if (nextBtn) {
      nextBtn.disabled = pagination.page >= pagination.totalPages;
    }
  }

  // Time ago helper function
  function timeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);

    const intervals = {
      year: 31536000,
      month: 2592000,
      week: 604800,
      day: 86400,
      hour: 3600,
      minute: 60
    };

    if (seconds < intervals.minute) {
      return 'Just now';
    }

    for (const [unit, secondsInUnit] of Object.entries(intervals)) {
      const interval = Math.floor(seconds / secondsInUnit);
      if (interval >= 1) {
        return `${interval} ${unit}${interval > 1 ? 's' : ''} ago`;
      }
    }

    return 'Just now';
  }

  // Pagination and search handlers for each role tab
  function setupTabHandlers(role, tabSuffix) {
    // Pagination handlers
    const prevBtn = el(`${tabSuffix}PrevPage`);
    const nextBtn = el(`${tabSuffix}NextPage`);
    const searchBtn = el(`${tabSuffix}SearchBtn`);
    const searchInput = el(`${tabSuffix}Search`);

    if (prevBtn) {
      prevBtn.addEventListener('click', () => {
        const currentPage = backofficeState.tabPages[tabSuffix] || 1;
        if (currentPage > 1) {
          loadRoleTabUsers(role, tabSuffix, currentPage - 1);
        }
      });
    }

    if (nextBtn) {
      nextBtn.addEventListener('click', () => {
        const currentPage = backofficeState.tabPages[tabSuffix] || 1;
        loadRoleTabUsers(role, tabSuffix, currentPage + 1);
      });
    }

    // Search handlers
    if (searchBtn) {
      searchBtn.addEventListener('click', () => {
        loadRoleTabUsers(role, tabSuffix, 1);
      });
    }

    if (searchInput) {
      searchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          loadRoleTabUsers(role, tabSuffix, 1);
        }
      });
    }

    // Add button handler
    const addBtn = el(`${tabSuffix}AddBtn`);
    const emailInput = el(`${tabSuffix}EmailInput`);
    if (addBtn && emailInput) {
      addBtn.addEventListener('click', () => addUserToRole(role, tabSuffix, emailInput));

      // Enter key to add
      emailInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          addUserToRole(role, tabSuffix, emailInput);
        }
      });

      // Real-time validation
      emailInput.addEventListener('input', (e) => validateEmailInput(e.target, tabSuffix));
    }
  }

  // Setup handlers for all role tabs
  setupTabHandlers('Executive', 'executive');
  setupTabHandlers('Sales', 'sales');
  setupTabHandlers('Customer', 'customer');

  // Audit log search handler
  const auditSearchBtn = el('auditSearchBtn');
  const auditSearch = el('auditSearch');
  if (auditSearchBtn) {
    auditSearchBtn.addEventListener('click', () => loadBackofficeAuditLog(true));
  }
  if (auditSearch) {
    auditSearch.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') loadBackofficeAuditLog(true);
    });
  }

  // Validate email input in real-time
  function validateEmailInput(input, tabSuffix) {
    const email = input.value.trim();
    const validationEl = el(`${tabSuffix}Validation`);

    if (!email) {
      if (validationEl) validationEl.textContent = '';
      input.classList.remove('border-green-500', 'border-red-500');
      return;
    }

    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    const isValid = emailRegex.test(email);

    // Check for duplicate in current tab
    const currentUsers = backofficeState.tabUsers[tabSuffix] || [];
    const isDuplicate = currentUsers.some(u => u.email.toLowerCase() === email.toLowerCase());

    if (!isValid) {
      if (validationEl) {
        validationEl.innerHTML = '<span class="text-red-500">‚úï Invalid email</span>';
      }
      input.classList.remove('border-green-500');
      input.classList.add('border-red-500');
    } else if (isDuplicate) {
      if (validationEl) {
        validationEl.innerHTML = '<span class="text-red-500">‚úï Already in this list</span>';
      }
      input.classList.remove('border-green-500');
      input.classList.add('border-red-500');
    } else {
      if (validationEl) {
        validationEl.innerHTML = '<span class="text-green-500">‚úì Press Enter or click Add</span>';
      }
      input.classList.remove('border-red-500');
      input.classList.add('border-green-500');
    }
  }

  // Add user to role via inline form
  async function addUserToRole(role, tabSuffix, emailInput) {
    const email = emailInput.value.trim();

    if (!email) {
      showNotification('Please enter an email address', 'error');
      return;
    }

    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      showNotification('Please enter a valid email address', 'error');
      return;
    }

    // Check for duplicate
    const currentUsers = backofficeState.tabUsers[tabSuffix] || [];
    const isDuplicate = currentUsers.some(u => u.email.toLowerCase() === email.toLowerCase());
    if (isDuplicate) {
      showNotification('This email is already in the list', 'error');
      return;
    }

    try {
      const response = await fetch(`/api/backoffice/users/${encodeURIComponent(email)}/role`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${backofficeState.token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ role })
      });

      if (!response.ok) {
        if (response.status === 401) {
          backofficeLogout();
          showNotification('Session expired. Please log in again.', 'error');
          return;
        }
        const data = await response.json();
        throw new Error(data.error || 'Failed to add user');
      }

      // Clear input and reload
      emailInput.value = '';
      const validationEl = el(`${tabSuffix}Validation`);
      if (validationEl) validationEl.textContent = '';
      emailInput.classList.remove('border-green-500', 'border-red-500');

      showNotification(`Added ${email} to ${role}`, 'success');
      loadRoleTabUsers(role, tabSuffix, 1); // Reload to show new user
    } catch (error) {
      console.error('Failed to add user:', error);
      showNotification(error.message || 'Failed to add user', 'error');
    }
  }

  // Load audit log
  async function loadBackofficeAuditLog(useSearch = false) {
    try {
      let url = new URL('/api/backoffice/audit-log', window.location.origin);

      // Add search parameter if provided
      if (useSearch) {
        const search = el('auditSearch')?.value || '';
        if (search) {
          url.searchParams.set('email', search);
        }
      }

      const response = await fetch(url.toString(), {
        headers: {
          'Authorization': `Bearer ${backofficeState.token}`
        }
      });

      if (!response.ok) {
        if (response.status === 401) {
          backofficeLogout();
          showNotification('Session expired. Please log in again.');
          return;
        }
        throw new Error('Failed to load audit log');
      }

      const data = await response.json();
      renderBackofficeAuditLog(data.entries);
    } catch (error) {
      console.error('Failed to load audit log:', error);
      el('backofficeAuditList').innerHTML = `
        <tr>
          <td colspan="5" class="px-4 py-8 text-center text-red-500">
            Failed to load audit log. ${error.message}
          </td>
        </tr>
      `;
    }
  }

  // Render audit log
  function renderBackofficeAuditLog(entries) {
    const container = el('backofficeAuditList');

    if (entries.length === 0) {
      container.innerHTML = `
        <tr>
          <td colspan="5" class="px-4 py-8 text-center text-slate-500">
            No audit entries found.
          </td>
        </tr>
      `;
      return;
    }

    container.innerHTML = entries.map(entry => `
      <tr class="hover:bg-slate-50">
        <td class="px-4 py-3">${entry.targetEmail}</td>
        <td class="px-4 py-3">
          <span class="px-2 py-1 text-xs font-semibold rounded ${
            entry.oldRole === 'Executive' ? 'bg-emerald-100 text-emerald-700' :
            entry.oldRole === 'Sales' ? 'bg-blue-100 text-blue-700' :
            entry.oldRole === 'Customer' ? 'bg-gray-100 text-gray-700' :
            'bg-slate-100 text-slate-600'
          }">
            ${entry.oldRole === 'NoRole' ? 'Unassigned' : entry.oldRole || 'Unassigned'}
          </span>
        </td>
        <td class="px-4 py-3">
          <span class="px-2 py-1 text-xs font-semibold rounded ${
            entry.newRole === 'Executive' ? 'bg-emerald-100 text-emerald-700' :
            entry.newRole === 'Sales' ? 'bg-blue-100 text-blue-700' :
            entry.newRole === 'Customer' ? 'bg-gray-100 text-gray-700' :
            'bg-slate-100 text-slate-600'
          }">
            ${entry.newRole === 'NoRole' ? 'Unassigned' : entry.newRole}
          </span>
        </td>
        <td class="px-4 py-3 text-slate-600">${entry.changedBy}</td>
        <td class="px-4 py-3 text-slate-600">${new Date(entry.changedAt).toLocaleString()}</td>
      </tr>
    `).join('');
  }

  // Role change modal
  window.openRoleChangeModal = function(email, currentRole) {
    backofficeState.currentEmail = email;
    el('roleChangeEmail').textContent = email;

    // Set current role as selected
    document.querySelectorAll('input[name="roleChange"]').forEach(radio => {
      radio.checked = radio.value === currentRole;
    });

    el('roleChangeModal').classList.remove('hidden');
  };

  el('roleChangeCancel').addEventListener('click', () => {
    el('roleChangeModal').classList.add('hidden');
    backofficeState.currentEmail = null;
  });

  el('roleChangeConfirm').addEventListener('click', async () => {
    const selectedRole = document.querySelector('input[name="roleChange"]:checked')?.value;
    if (!selectedRole || !backofficeState.currentEmail) return;

    try {
      const response = await fetch(`/api/backoffice/users/${encodeURIComponent(backofficeState.currentEmail)}/role`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${backofficeState.token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ role: selectedRole })
      });

      if (!response.ok) {
        if (response.status === 401) {
          backofficeLogout();
          showNotification('Session expired. Please log in again.');
          return;
        }
        throw new Error('Failed to update role');
      }

      // Close modal and refresh current tab
      el('roleChangeModal').classList.add('hidden');

      // Refresh the current tab based on new role
      const roleToTabMap = {
        'Executive': ['Executive', 'executive'],
        'Sales': ['Sales', 'sales'],
        'Customer': ['Customer', 'customer'],
        'NoRole': null // NoRole users don't appear in any tab
      };

      const mapping = roleToTabMap[selectedRole];
      if (mapping) {
        loadRoleTabUsers(mapping[0], mapping[1], 1);
      } else {
        // If changed to NoRole, refresh current tab to remove the user
        const currentTab = backofficeState.currentTab;
        if (currentTab === 'executives') loadRoleTabUsers('Executive', 'executive', backofficeState.tabPages.executives);
        else if (currentTab === 'sales') loadRoleTabUsers('Sales', 'sales', backofficeState.tabPages.sales);
        else if (currentTab === 'customers') loadRoleTabUsers('Customer', 'customer', backofficeState.tabPages.customers);
      }

      showNotification('Role updated successfully');
    } catch (error) {
      console.error('Failed to update role:', error);
      showNotification('Failed to update role', 'error');
    }

    backofficeState.currentEmail = null;
  });

  // Close modal on outside click
  el('roleChangeModal').addEventListener('click', (e) => {
    if (e.target.id === 'roleChangeModal') {
      el('roleChangeModal').classList.add('hidden');
      backofficeState.currentEmail = null;
    }
  });

  // Hash-based routing for backoffice
  function handleHashChange() {
    const hash = window.location.hash;

    if (hash === '#login' || hash === '' || hash === '#') {
      if (checkBackofficeSession()) {
        window.location.hash = '#dashboard';
      } else {
        // Only show login if not already initializing a session
        if (!backofficeState.isInitializing) {
          showView('backoffice-login');
        }
      }
    } else if (hash === '#dashboard') {
      if (checkBackofficeSession()) {
        showBackofficeDashboard();
      } else {
        window.location.hash = '#login';
      }
    }
  }

  // Listen for hash changes
  window.addEventListener('hashchange', handleHashChange);

  // Check hash on page load (after init)
  setTimeout(() => {
    handleHashChange();
  }, 100);
</script>
</body>
</html>
