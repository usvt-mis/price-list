<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Backoffice Admin</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üîê</text></svg>"/>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-6xl mx-auto p-6 space-y-6">

    <!-- Loading View -->
    <div id="loadingView">
      <div class="flex items-center justify-center min-h-[60vh]">
        <div class="text-center">
          <div class="animate-spin w-12 h-12 border-4 border-purple-600 border-t-transparent rounded-full mx-auto mb-4"></div>
          <p class="text-slate-600">Checking authentication...</p>
        </div>
      </div>
    </div>

    <!-- Azure AD Login Required View -->
    <div id="azureAdLoginView" class="hidden">
      <div class="flex items-center justify-center min-h-[60vh]">
        <div class="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full mx-4 text-center">
          <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
          </div>
          <h1 class="text-2xl font-bold text-slate-900 mb-2">Backoffice Admin</h1>
          <p class="text-slate-600 mb-6">Sign in with your Azure AD account to continue</p>
          <a href="/.auth/login/aad?post_login_redirect_uri=/backoffice.html" class="inline-block px-6 py-3 rounded-lg bg-purple-600 text-white font-medium hover:bg-purple-700 transition-colors">
            Sign in with Azure AD
          </a>
        </div>
      </div>
    </div>

    <!-- Access Denied View (shown when user email is not authorized) -->
    <div id="accessDeniedView" class="hidden">
      <div class="flex items-center justify-center min-h-[60vh]">
        <div class="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full mx-4 text-center">
          <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
            </svg>
          </div>
          <h1 class="text-2xl font-bold text-slate-900 mb-2">Access Denied</h1>
          <p class="text-slate-600 mb-6">Backoffice access is restricted to authorized users only.</p>
          <a href="/.auth/logout?post_logout_redirect_uri=/backoffice.html" class="inline-block px-6 py-3 rounded-lg border border-slate-200 text-slate-700 hover:bg-slate-50 transition-colors">
            Sign Out
          </a>
        </div>
      </div>
    </div>

    <!-- Backoffice Dashboard View -->
    <div id="backofficeDashboardView" class="hidden">
      <div class="bg-white rounded-2xl shadow p-6">
        <div class="flex items-center justify-between mb-6">
          <div>
            <h1 class="text-2xl font-bold text-slate-900">Backoffice Dashboard</h1>
            <p class="text-sm text-slate-500">Manage user role assignments</p>
          </div>
          <div class="flex items-center gap-3">
            <span id="backofficeUserName" class="text-sm text-slate-600"></span>
            <button id="logoutButton" class="px-4 py-2 text-sm rounded-lg border border-slate-200 hover:bg-slate-50 transition-colors">
              Logout
            </button>
          </div>
        </div>

        <!-- Tabs -->
        <div class="flex items-center gap-1 bg-slate-100 rounded-lg p-1 mb-6 overflow-x-auto">
          <button onclick="showBackofficeTab('executives')" id="backofficeTabExecutives" class="px-4 py-2 text-sm font-medium rounded-md transition-colors whitespace-nowrap">
            Executives <span id="executiveCount" class="ml-1 px-2 py-0.5 text-xs bg-purple-200 text-purple-700 rounded-full">0</span>
          </button>
          <button onclick="showBackofficeTab('sales')" id="backofficeTabSales" class="px-4 py-2 text-sm font-medium rounded-md transition-colors whitespace-nowrap">
            Sales <span id="salesCount" class="ml-1 px-2 py-0.5 text-xs bg-blue-200 text-blue-700 rounded-full">0</span>
          </button>
          <button onclick="showBackofficeTab('customers')" id="backofficeTabCustomers" class="px-4 py-2 text-sm font-medium rounded-md transition-colors whitespace-nowrap">
            Customers <span id="customerCount" class="ml-1 px-2 py-0.5 text-xs bg-gray-200 text-gray-700 rounded-full">0</span>
          </button>
          <button onclick="showBackofficeTab('audit')" id="backofficeTabAudit" class="px-4 py-2 text-sm font-medium rounded-md transition-colors whitespace-nowrap">
            Audit Log
          </button>
          <button onclick="showBackofficeTab('settings')" id="backofficeTabSettings" class="px-4 py-2 text-sm font-medium rounded-md transition-colors whitespace-nowrap">
            Settings
          </button>
        </div>

        <!-- Executives Tab -->
        <div id="backofficeExecutivesTab" class="hidden">
          <!-- Inline Add Form -->
          <div class="flex flex-col sm:flex-row gap-3 mb-6 p-4 bg-purple-50 rounded-lg border border-purple-200">
            <div class="flex-1">
              <input id="executiveEmailInput" type="email" placeholder="Enter email to add to Executives..."
                class="w-full px-4 py-2 rounded-lg border border-purple-300 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
            </div>
            <div class="flex items-center gap-2">
              <span id="executiveValidation" class="text-sm"></span>
              <button id="executiveAddBtn" class="px-4 py-2 rounded-lg bg-purple-600 text-white text-sm hover:bg-purple-700 transition-colors">
                Add
              </button>
            </div>
          </div>

          <!-- Search -->
          <div class="flex flex-col sm:flex-row gap-4 mb-6">
            <div class="flex-1">
              <input id="executiveSearch" type="text" placeholder="Search Executives by email..."
                class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
            </div>
            <button id="executiveSearchBtn" class="px-4 py-2 rounded-lg bg-slate-900 text-white text-sm hover:bg-slate-800 transition-colors">
              Search
            </button>
          </div>

          <!-- Users Table -->
          <div class="border border-slate-200 rounded-lg overflow-hidden">
            <table class="w-full text-sm">
              <thead class="bg-slate-50 text-slate-600">
                <tr>
                  <th class="text-left px-4 py-3 font-medium">Email</th>
                  <th class="text-left px-4 py-3 font-medium">Status</th>
                  <th class="text-left px-4 py-3 font-medium">Assigned By</th>
                  <th class="text-left px-4 py-3 font-medium">Last Login</th>
                  <th class="text-left px-4 py-3 font-medium">Actions</th>
                </tr>
              </thead>
              <tbody id="executiveUsersList" class="divide-y divide-slate-100">
                <tr>
                  <td colspan="5" class="px-4 py-8 text-center text-slate-500">Loading Executives...</td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          <div id="executivePagination" class="flex items-center justify-between mt-4">
            <span id="executivePaginationInfo" class="text-sm text-slate-600"></span>
            <div class="flex items-center gap-2">
              <button id="executivePrevPage" class="px-3 py-1 rounded border border-slate-200 text-sm hover:bg-slate-50 disabled:opacity-50" disabled>
                Previous
              </button>
              <button id="executiveNextPage" class="px-3 py-1 rounded border border-slate-200 text-sm hover:bg-slate-50 disabled:opacity-50" disabled>
                Next
              </button>
            </div>
          </div>
        </div>

        <!-- Sales Tab -->
        <div id="backofficeSalesTab" class="hidden">
          <!-- Inline Add Form -->
          <div class="flex flex-col sm:flex-row gap-3 mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
            <div class="flex-1">
              <input id="salesEmailInput" type="email" placeholder="Enter email to add to Sales..."
                class="w-full px-4 py-2 rounded-lg border border-blue-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            <div class="flex items-center gap-2">
              <span id="salesValidation" class="text-sm"></span>
              <button id="salesAddBtn" class="px-4 py-2 rounded-lg bg-blue-600 text-white text-sm hover:bg-blue-700 transition-colors">
                Add
              </button>
            </div>
          </div>

          <!-- Search -->
          <div class="flex flex-col sm:flex-row gap-4 mb-6">
            <div class="flex-1">
              <input id="salesSearch" type="text" placeholder="Search Sales by email..."
                class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            <button id="salesSearchBtn" class="px-4 py-2 rounded-lg bg-slate-900 text-white text-sm hover:bg-slate-800 transition-colors">
              Search
            </button>
          </div>

          <!-- Users Table -->
          <div class="border border-slate-200 rounded-lg overflow-hidden">
            <table class="w-full text-sm">
              <thead class="bg-slate-50 text-slate-600">
                <tr>
                  <th class="text-left px-4 py-3 font-medium">Email</th>
                  <th class="text-left px-4 py-3 font-medium">Status</th>
                  <th class="text-left px-4 py-3 font-medium">Assigned By</th>
                  <th class="text-left px-4 py-3 font-medium">Last Login</th>
                  <th class="text-left px-4 py-3 font-medium">Actions</th>
                </tr>
              </thead>
              <tbody id="salesUsersList" class="divide-y divide-slate-100">
                <tr>
                  <td colspan="5" class="px-4 py-8 text-center text-slate-500">Loading Sales...</td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          <div id="salesPagination" class="flex items-center justify-between mt-4">
            <span id="salesPaginationInfo" class="text-sm text-slate-600"></span>
            <div class="flex items-center gap-2">
              <button id="salesPrevPage" class="px-3 py-1 rounded border border-slate-200 text-sm hover:bg-slate-50 disabled:opacity-50" disabled>
                Previous
              </button>
              <button id="salesNextPage" class="px-3 py-1 rounded border border-slate-200 text-sm hover:bg-slate-50 disabled:opacity-50" disabled>
                Next
              </button>
            </div>
          </div>
        </div>

        <!-- Customers Tab -->
        <div id="backofficeCustomersTab" class="hidden">
          <!-- Info Banner -->
          <div class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
            <p class="text-sm text-gray-600">
              <strong>Customers</strong> are pre-registered users who can only view calculations shared via link. They do not have login access.
            </p>
          </div>

          <!-- Inline Add Form -->
          <div class="flex flex-col sm:flex-row gap-3 mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
            <div class="flex-1">
              <input id="customerEmailInput" type="email" placeholder="Enter email to add to Customers..."
                class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:border-transparent">
            </div>
            <div class="flex items-center gap-2">
              <span id="customerValidation" class="text-sm"></span>
              <button id="customerAddBtn" class="px-4 py-2 rounded-lg bg-gray-600 text-white text-sm hover:bg-gray-700 transition-colors">
                Add
              </button>
            </div>
          </div>

          <!-- Search -->
          <div class="flex flex-col sm:flex-row gap-4 mb-6">
            <div class="flex-1">
              <input id="customerSearch" type="text" placeholder="Search Customers by email..."
                class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:border-transparent">
            </div>
            <button id="customerSearchBtn" class="px-4 py-2 rounded-lg bg-slate-900 text-white text-sm hover:bg-slate-800 transition-colors">
              Search
            </button>
          </div>

          <!-- Users Table -->
          <div class="border border-slate-200 rounded-lg overflow-hidden">
            <table class="w-full text-sm">
              <thead class="bg-slate-50 text-slate-600">
                <tr>
                  <th class="text-left px-4 py-3 font-medium">Email</th>
                  <th class="text-left px-4 py-3 font-medium">Status</th>
                  <th class="text-left px-4 py-3 font-medium">Assigned By</th>
                  <th class="text-left px-4 py-3 font-medium">Assigned At</th>
                  <th class="text-left px-4 py-3 font-medium">Actions</th>
                </tr>
              </thead>
              <tbody id="customerUsersList" class="divide-y divide-slate-100">
                <tr>
                  <td colspan="5" class="px-4 py-8 text-center text-slate-500">Loading Customers...</td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          <div id="customerPagination" class="flex items-center justify-between mt-4">
            <span id="customerPaginationInfo" class="text-sm text-slate-600"></span>
            <div class="flex items-center gap-2">
              <button id="customerPrevPage" class="px-3 py-1 rounded border border-slate-200 text-sm hover:bg-slate-50 disabled:opacity-50" disabled>
                Previous
              </button>
              <button id="customerNextPage" class="px-3 py-1 rounded border border-slate-200 text-sm hover:bg-slate-50 disabled:opacity-50" disabled>
                Next
              </button>
            </div>
          </div>
        </div>

        <!-- Audit Log Tab -->
        <div id="backofficeAuditTab" class="hidden">
          <!-- Search -->
          <div class="flex flex-col sm:flex-row gap-4 mb-6">
            <div class="flex-1">
              <input id="auditSearch" type="text" placeholder="Search audit log by email..."
                class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
            </div>
            <button id="auditSearchBtn" class="px-4 py-2 rounded-lg bg-slate-900 text-white text-sm hover:bg-slate-800 transition-colors">
              Search
            </button>
          </div>

          <!-- Audit Table -->
          <div class="border border-slate-200 rounded-lg overflow-hidden">
            <table class="w-full text-sm">
              <thead class="bg-slate-50 text-slate-600">
                <tr>
                  <th class="text-left px-4 py-3 font-medium">Target Email</th>
                  <th class="text-left px-4 py-3 font-medium">Old Role</th>
                  <th class="text-left px-4 py-3 font-medium">New Role</th>
                  <th class="text-left px-4 py-3 font-medium">Changed By</th>
                  <th class="text-left px-4 py-3 font-medium">Changed At</th>
                </tr>
              </thead>
              <tbody id="backofficeAuditList" class="divide-y divide-slate-100">
                <tr>
                  <td colspan="5" class="px-4 py-8 text-center text-slate-500">Loading audit log...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Settings Tab -->
        <div id="backofficeSettingsTab" class="hidden">
          <h2 class="text-xl font-bold text-slate-900 mb-4">Settings</h2>

          <div class="p-6 bg-white rounded-lg border border-slate-200">
            <p class="text-slate-600">Backoffice is configured for Azure AD authentication only.</p>
            <p class="text-sm text-slate-500 mt-2">Access is restricted to <code>it@uservices-thailand.com</code></p>
          </div>
        </div>
      </div>
    </div>

    <!-- Role Change Modal (hidden by default) -->
    <div id="roleChangeModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 backdrop-blur-sm">
      <div class="bg-white rounded-2xl shadow-xl p-6 max-w-sm w-full mx-4">
        <h3 class="text-xl font-bold text-slate-900 mb-4">Change Role</h3>
        <p class="text-sm text-slate-600 mb-4">Select new role for <strong id="roleChangeEmail"></strong>:</p>

        <div class="space-y-3 mb-6">
          <label class="flex items-center gap-3 p-3 rounded-lg border border-slate-200 hover:bg-slate-50 cursor-pointer">
            <input type="radio" name="roleChange" value="NoRole" class="text-purple-600">
            <div>
              <div class="font-medium text-slate-900">Unassigned</div>
              <div class="text-xs text-slate-500">No access - "Awaiting Assignment"</div>
            </div>
          </label>
          <label class="flex items-center gap-3 p-3 rounded-lg border border-slate-200 hover:bg-slate-50 cursor-pointer">
            <input type="radio" name="roleChange" value="Sales" class="text-blue-600">
            <div>
              <div class="font-medium text-slate-900">Sales</div>
              <div class="text-xs text-slate-500">Can view and save calculations</div>
            </div>
          </label>
          <label class="flex items-center gap-3 p-3 rounded-lg border border-slate-200 hover:bg-slate-50 cursor-pointer">
            <input type="radio" name="roleChange" value="Executive" class="text-emerald-600">
            <div>
              <div class="font-medium text-slate-900">Executive</div>
              <div class="text-xs text-slate-500">Full access including admin features</div>
            </div>
          </label>
          <label class="flex items-center gap-3 p-3 rounded-lg border border-slate-200 hover:bg-slate-50 cursor-pointer">
            <input type="radio" name="roleChange" value="Customer" class="text-gray-600">
            <div>
              <div class="font-medium text-slate-900">Customer</div>
              <div class="text-xs text-slate-500">Pre-registered for shared links only</div>
            </div>
          </label>
        </div>

        <div class="flex gap-3">
          <button id="roleChangeCancel" class="flex-1 px-4 py-2 rounded-lg border border-slate-200 text-slate-700 hover:bg-slate-50 transition-colors">
            Cancel
          </button>
          <button id="roleChangeConfirm" class="flex-1 px-4 py-2 rounded-lg bg-purple-600 text-white hover:bg-purple-700 transition-colors">
            Change Role
          </button>
        </div>
      </div>
    </div>

    <!-- Notification Toast (hidden by default) -->
    <div id="notificationToast" class="hidden fixed bottom-6 right-6 z-50 px-6 py-4 rounded-lg shadow-lg text-sm font-medium transition-all transform">
      <span id="notificationMessage"></span>
    </div>

  </div>

<script>
  // ========== CONSTANTS ==========
  const isLocalDev = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

  // ========== STATE ==========
  let backofficeState = {
    currentTab: 'executives',
    currentPage: 1,
    pageSize: 50,
    totalPages: 0,
    currentEmail: null,
    tabPages: {
      executives: 1,
      sales: 1,
      customers: 1
    },
    tabUsers: {
      executives: [],
      sales: [],
      customers: []
    }
  };

  // ========== UTILITY FUNCTIONS ==========
  function el(id) {
    return document.getElementById(id);
  }

  function showNotification(message, type = 'success') {
    const toast = el('notificationToast');
    const messageEl = el('notificationMessage');

    messageEl.textContent = message;

    toast.className = `fixed bottom-6 right-6 z-50 px-6 py-4 rounded-lg shadow-lg text-sm font-medium transition-all transform ${
      type === 'success'
        ? 'bg-emerald-600 text-white'
        : type === 'error'
        ? 'bg-red-600 text-white'
        : 'bg-slate-800 text-white'
    }`;

    toast.classList.remove('hidden');

    setTimeout(() => {
      toast.classList.add('hidden');
    }, 3000);
  }

  function showView(view) {
    el('loadingView').classList.add('hidden');
    el('azureAdLoginView').classList.add('hidden');
    el('accessDeniedView').classList.add('hidden');
    el('backofficeDashboardView').classList.add('hidden');

    if (view === 'loading') {
      el('loadingView').classList.remove('hidden');
    } else if (view === 'azure-ad-login') {
      el('azureAdLoginView').classList.remove('hidden');
    } else if (view === 'access-denied') {
      el('accessDeniedView').classList.remove('hidden');
    } else if (view === 'dashboard') {
      el('backofficeDashboardView').classList.remove('hidden');
    }
  }

  // ========== AUTHENTICATION ==========

  // Get Azure AD user info
  async function getUserInfo() {
    if (isLocalDev) {
      return {
        userDetails: 'it@uservices-thailand.com',
        userId: 'dev-user',
        userRoles: ['authenticated']
      };
    }

    const response = await fetch('/.auth/me');
    if (!response.ok) return null;
    const data = await response.json();
    return data.clientPrincipal;
  }

  // Make authenticated API call (Azure AD handles auth automatically)
  async function fetchWithAuth(url, options = {}) {
    const headers = {
      ...options.headers,
      'Content-Type': 'application/json'
    };

    const response = await fetch(url, { ...options, headers });

    if (response.status === 401 || response.status === 403) {
      // Access denied - redirect to access denied view
      showView('access-denied');
      throw new Error('Access denied');
    }

    return response;
  }

  // Verify backoffice access by checking email authorization
  async function verifyBackofficeAccess() {
    try {
      const response = await fetch('/api/backoffice/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });

      if (response.ok) {
        return true;
      } else if (response.status === 403) {
        return false;
      }
      return false;
    } catch (error) {
      console.error('Access verification failed:', error);
      return false;
    }
  }

  // Logout
  function handleLogout() {
    // Redirect to Azure AD logout
    window.location.href = '/.auth/logout?post_logout_redirect_uri=/backoffice.html';
  }

  // ========== INITIALIZATION ==========

  async function initializePage() {
    showView('loading');

    try {
      // Step 1: Check Azure AD authentication
      const azureUser = await getUserInfo();

      if (!azureUser) {
        showView('azure-ad-login');
        return;
      }

      // Step 2: Verify backoffice access (email authorization)
      const hasAccess = await verifyBackofficeAccess();

      if (!hasAccess) {
        showView('access-denied');
        return;
      }

      // Step 3: Load dashboard
      if (el('backofficeUserName')) {
        el('backofficeUserName').textContent = `Logged in as ${azureUser.userDetails}`;
      }
      showView('dashboard');
      showBackofficeTab('executives');

    } catch (error) {
      console.error('Initialization error:', error);
      showView('azure-ad-login');
    }
  }

  // Logout button
  el('logoutButton')?.addEventListener('click', handleLogout);

  // ========== DASHBOARD TAB MANAGEMENT ==========

  window.showBackofficeTab = function(tab) {
    backofficeState.currentTab = tab;

    // Reset all tab button styles
    const tabButtons = ['backofficeTabExecutives', 'backofficeTabSales', 'backofficeTabCustomers', 'backofficeTabAudit', 'backofficeTabSettings'];
    tabButtons.forEach(btnId => {
      if (el(btnId)) {
        el(btnId).classList.remove('bg-white', 'shadow-sm', 'text-purple-600', 'text-blue-600', 'text-gray-600');
        el(btnId).classList.add('text-slate-600', 'hover:text-slate-900');
      }
    });

    // Hide all tab contents
    const tabContents = ['backofficeExecutivesTab', 'backofficeSalesTab', 'backofficeCustomersTab', 'backofficeAuditTab', 'backofficeSettingsTab'];
    tabContents.forEach(contentId => {
      if (el(contentId)) {
        el(contentId).classList.add('hidden');
      }
    });

    // Show selected tab
    if (tab === 'executives') {
      if (el('backofficeTabExecutives')) {
        el('backofficeTabExecutives').classList.add('bg-white', 'shadow-sm', 'text-purple-600');
        el('backofficeTabExecutives').classList.remove('text-slate-600', 'hover:text-slate-900');
      }
      if (el('backofficeExecutivesTab')) {
        el('backofficeExecutivesTab').classList.remove('hidden');
      }
      loadRoleTabUsers('Executive', 'executive');
    } else if (tab === 'sales') {
      if (el('backofficeTabSales')) {
        el('backofficeTabSales').classList.add('bg-white', 'shadow-sm', 'text-blue-600');
        el('backofficeTabSales').classList.remove('text-slate-600', 'hover:text-slate-900');
      }
      if (el('backofficeSalesTab')) {
        el('backofficeSalesTab').classList.remove('hidden');
      }
      loadRoleTabUsers('Sales', 'sales');
    } else if (tab === 'customers') {
      if (el('backofficeTabCustomers')) {
        el('backofficeTabCustomers').classList.add('bg-white', 'shadow-sm', 'text-gray-600');
        el('backofficeTabCustomers').classList.remove('text-slate-600', 'hover:text-slate-900');
      }
      if (el('backofficeCustomersTab')) {
        el('backofficeCustomersTab').classList.remove('hidden');
      }
      loadRoleTabUsers('Customer', 'customer');
    } else if (tab === 'audit') {
      if (el('backofficeTabAudit')) {
        el('backofficeTabAudit').classList.add('bg-white', 'shadow-sm', 'text-purple-600');
        el('backofficeTabAudit').classList.remove('text-slate-600', 'hover:text-slate-900');
      }
      if (el('backofficeAuditTab')) {
        el('backofficeAuditTab').classList.remove('hidden');
      }
      loadBackofficeAuditLog();
    } else if (tab === 'settings') {
      if (el('backofficeTabSettings')) {
        el('backofficeTabSettings').classList.add('bg-white', 'shadow-sm', 'text-purple-600');
        el('backofficeTabSettings').classList.remove('text-slate-600', 'hover:text-slate-900');
      }
      if (el('backofficeSettingsTab')) {
        el('backofficeSettingsTab').classList.remove('hidden');
      }
    }
  };

  // ========== API CALLS ==========

  async function loadRoleTabUsers(role, tabSuffix, page = null) {
    if (page === null) {
      page = backofficeState.tabPages[tabSuffix] || 1;
    }
    backofficeState.tabPages[tabSuffix] = page;

    const searchInput = el(`${tabSuffix}Search`);
    const search = searchInput?.value || '';
    const pageSize = backofficeState.pageSize;

    try {
      const url = new URL('/api/backoffice/users', window.location.origin);
      url.searchParams.set('page', page);
      url.searchParams.set('pageSize', pageSize);
      url.searchParams.set('role', role);
      if (search) url.searchParams.set('search', search);

      const response = await fetchWithAuth(url.toString());

      if (!response.ok) {
        if (response.status === 401 || response.status === 403) {
          showNotification('Access denied. Please log in again.', 'error');
          setTimeout(() => initializePage(), 2000);
          return;
        }
        throw new Error(`Failed to load ${role} users`);
      }

      const data = await response.json();
      backofficeState.tabPages[tabSuffix] = page;
      backofficeState.tabUsers[tabSuffix] = data.users;

      // Update count badge
      const countBadge = el(`${tabSuffix}Count`);
      if (countBadge) {
        countBadge.textContent = data.pagination.total;
      }

      renderRoleTabUsers(data.users, tabSuffix, role);
      updateRoleTabPagination(data.pagination, tabSuffix);
    } catch (error) {
      console.error(`Failed to load ${role} users:`, error);
      const listId = `${tabSuffix}UsersList`;
      const container = el(listId);
      if (container) {
        container.innerHTML = `
          <tr>
            <td colspan="5" class="px-4 py-8 text-center text-red-500">
              Failed to load users. ${error.message}
            </td>
          </tr>
        `;
      }
    }
  }

  function renderRoleTabUsers(users, tabSuffix, role) {
    const container = el(`${tabSuffix}UsersList`);
    if (!container) return;

    if (users.length === 0) {
      container.innerHTML = `
        <tr>
          <td colspan="5" class="px-4 py-8 text-center text-slate-500">
            No ${role.toLowerCase()} users found.
          </td>
        </tr>
      `;
      return;
    }

    container.innerHTML = users.map(user => {
      const isActive = user.lastLoginAt !== null;
      const lastLoginText = user.lastLoginAt
        ? timeAgo(new Date(user.lastLoginAt))
        : 'Never';

      return `
        <tr class="hover:bg-slate-50">
          <td class="px-4 py-3 font-medium">${user.email}</td>
          <td class="px-4 py-3">
            <span class="px-2 py-1 text-xs font-semibold rounded ${
              isActive
                ? 'bg-green-100 text-green-700'
                : 'bg-gray-100 text-gray-600'
            }">
              ${isActive ? 'Active' : 'Pending'}
            </span>
          </td>
          <td class="px-4 py-3 text-slate-600">${user.assignedBy || 'System'}</td>
          <td class="px-4 py-3 text-slate-600">${lastLoginText}</td>
          <td class="px-4 py-3">
            <button onclick="openRoleChangeModal('${user.email}', '${user.role}')" class="px-3 py-1 text-xs font-medium rounded border border-purple-200 text-purple-700 hover:bg-purple-50 transition-colors">
              Change
            </button>
          </td>
        </tr>
      `;
    }).join('');
  }

  function updateRoleTabPagination(pagination, tabSuffix) {
    const infoEl = el(`${tabSuffix}PaginationInfo`);
    const prevBtn = el(`${tabSuffix}PrevPage`);
    const nextBtn = el(`${tabSuffix}NextPage`);

    if (infoEl) {
      infoEl.textContent = `Page ${pagination.page} of ${pagination.totalPages} (${pagination.total} total)`;
    }
    if (prevBtn) {
      prevBtn.disabled = pagination.page <= 1;
    }
    if (nextBtn) {
      nextBtn.disabled = pagination.page >= pagination.totalPages;
    }
  }

  function timeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);

    const intervals = {
      year: 31536000,
      month: 2592000,
      week: 604800,
      day: 86400,
      hour: 3600,
      minute: 60
    };

    if (seconds < intervals.minute) {
      return 'Just now';
    }

    for (const [unit, secondsInUnit] of Object.entries(intervals)) {
      const interval = Math.floor(seconds / secondsInUnit);
      if (interval >= 1) {
        return `${interval} ${unit}${interval > 1 ? 's' : ''} ago`;
      }
    }

    return 'Just now';
  }

  function setupTabHandlers(role, tabSuffix) {
    const prevBtn = el(`${tabSuffix}PrevPage`);
    const nextBtn = el(`${tabSuffix}NextPage`);
    const searchBtn = el(`${tabSuffix}SearchBtn`);
    const searchInput = el(`${tabSuffix}Search`);

    if (prevBtn) {
      prevBtn.addEventListener('click', () => {
        const currentPage = backofficeState.tabPages[tabSuffix] || 1;
        if (currentPage > 1) {
          loadRoleTabUsers(role, tabSuffix, currentPage - 1);
        }
      });
    }

    if (nextBtn) {
      nextBtn.addEventListener('click', () => {
        const currentPage = backofficeState.tabPages[tabSuffix] || 1;
        loadRoleTabUsers(role, tabSuffix, currentPage + 1);
      });
    }

    if (searchBtn) {
      searchBtn.addEventListener('click', () => {
        loadRoleTabUsers(role, tabSuffix, 1);
      });
    }

    if (searchInput) {
      searchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          loadRoleTabUsers(role, tabSuffix, 1);
        }
      });
    }

    const addBtn = el(`${tabSuffix}AddBtn`);
    const emailInput = el(`${tabSuffix}EmailInput`);
    if (addBtn && emailInput) {
      addBtn.addEventListener('click', () => addUserToRole(role, tabSuffix, emailInput));

      emailInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          addUserToRole(role, tabSuffix, emailInput);
        }
      });

      emailInput.addEventListener('input', (e) => validateEmailInput(e.target, tabSuffix));
    }
  }

  setupTabHandlers('Executive', 'executive');
  setupTabHandlers('Sales', 'sales');
  setupTabHandlers('Customer', 'customer');

  const auditSearchBtn = el('auditSearchBtn');
  const auditSearch = el('auditSearch');
  if (auditSearchBtn) {
    auditSearchBtn.addEventListener('click', () => loadBackofficeAuditLog(true));
  }
  if (auditSearch) {
    auditSearch.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') loadBackofficeAuditLog(true);
    });
  }

  function validateEmailInput(input, tabSuffix) {
    const email = input.value.trim();
    const validationEl = el(`${tabSuffix}Validation`);

    if (!email) {
      if (validationEl) validationEl.textContent = '';
      input.classList.remove('border-green-500', 'border-red-500');
      return;
    }

    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    const isValid = emailRegex.test(email);

    const currentUsers = backofficeState.tabUsers[tabSuffix] || [];
    const isDuplicate = currentUsers.some(u => u.email.toLowerCase() === email.toLowerCase());

    if (!isValid) {
      if (validationEl) {
        validationEl.innerHTML = '<span class="text-red-500">‚úï Invalid email</span>';
      }
      input.classList.remove('border-green-500');
      input.classList.add('border-red-500');
    } else if (isDuplicate) {
      if (validationEl) {
        validationEl.innerHTML = '<span class="text-red-500">‚úï Already in this list</span>';
      }
      input.classList.remove('border-green-500');
      input.classList.add('border-red-500');
    } else {
      if (validationEl) {
        validationEl.innerHTML = '<span class="text-green-500">‚úì Press Enter or click Add</span>';
      }
      input.classList.remove('border-red-500');
      input.classList.add('border-green-500');
    }
  }

  async function addUserToRole(role, tabSuffix, emailInput) {
    const email = emailInput.value.trim();

    if (!email) {
      showNotification('Please enter an email address', 'error');
      return;
    }

    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      showNotification('Please enter a valid email address', 'error');
      return;
    }

    const currentUsers = backofficeState.tabUsers[tabSuffix] || [];
    const isDuplicate = currentUsers.some(u => u.email.toLowerCase() === email.toLowerCase());
    if (isDuplicate) {
      showNotification('This email is already in the list', 'error');
      return;
    }

    try {
      const response = await fetchWithAuth(`/api/backoffice/users/${encodeURIComponent(email)}/role`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ role })
      });

      if (!response.ok) {
        if (response.status === 401 || response.status === 403) {
          showNotification('Access denied. Please log in again.', 'error');
          setTimeout(() => initializePage(), 2000);
          return;
        }
        const data = await response.json();
        throw new Error(data.error || 'Failed to add user');
      }

      emailInput.value = '';
      const validationEl = el(`${tabSuffix}Validation`);
      if (validationEl) validationEl.textContent = '';
      emailInput.classList.remove('border-green-500', 'border-red-500');

      showNotification(`Added ${email} to ${role}`, 'success');
      loadRoleTabUsers(role, tabSuffix, 1);
    } catch (error) {
      console.error('Failed to add user:', error);
      showNotification(error.message || 'Failed to add user', 'error');
    }
  }

  async function loadBackofficeAuditLog(useSearch = false) {
    try {
      let url = new URL('/api/backoffice/audit-log', window.location.origin);

      if (useSearch) {
        const search = el('auditSearch')?.value || '';
        if (search) {
          url.searchParams.set('email', search);
        }
      }

      const response = await fetchWithAuth(url.toString());

      if (!response.ok) {
        if (response.status === 401 || response.status === 403) {
          showNotification('Access denied. Please log in again.', 'error');
          setTimeout(() => initializePage(), 2000);
          return;
        }
        throw new Error('Failed to load audit log');
      }

      const data = await response.json();
      renderBackofficeAuditLog(data.entries);
    } catch (error) {
      console.error('Failed to load audit log:', error);
      el('backofficeAuditList').innerHTML = `
        <tr>
          <td colspan="5" class="px-4 py-8 text-center text-red-500">
            Failed to load audit log. ${error.message}
          </td>
        </tr>
      `;
    }
  }

  function renderBackofficeAuditLog(entries) {
    const container = el('backofficeAuditList');

    if (entries.length === 0) {
      container.innerHTML = `
        <tr>
          <td colspan="5" class="px-4 py-8 text-center text-slate-500">
            No audit entries found.
          </td>
        </tr>
      `;
      return;
    }

    container.innerHTML = entries.map(entry => `
      <tr class="hover:bg-slate-50">
        <td class="px-4 py-3">${entry.targetEmail}</td>
        <td class="px-4 py-3">
          <span class="px-2 py-1 text-xs font-semibold rounded ${
            entry.oldRole === 'Executive' ? 'bg-emerald-100 text-emerald-700' :
            entry.oldRole === 'Sales' ? 'bg-blue-100 text-blue-700' :
            entry.oldRole === 'Customer' ? 'bg-gray-100 text-gray-700' :
            'bg-slate-100 text-slate-600'
          }">
            ${entry.oldRole === 'NoRole' ? 'Unassigned' : entry.oldRole || 'Unassigned'}
          </span>
        </td>
        <td class="px-4 py-3">
          <span class="px-2 py-1 text-xs font-semibold rounded ${
            entry.newRole === 'Executive' ? 'bg-emerald-100 text-emerald-700' :
            entry.newRole === 'Sales' ? 'bg-blue-100 text-blue-700' :
            entry.newRole === 'Customer' ? 'bg-gray-100 text-gray-700' :
            'bg-slate-100 text-slate-600'
          }">
            ${entry.newRole === 'NoRole' ? 'Unassigned' : entry.newRole}
          </span>
        </td>
        <td class="px-4 py-3 text-slate-600">${entry.changedBy}</td>
        <td class="px-4 py-3 text-slate-600">${new Date(entry.changedAt).toLocaleString()}</td>
      </tr>
    `).join('');
  }

  // ========== ROLE CHANGE MODAL ==========

  window.openRoleChangeModal = function(email, currentRole) {
    backofficeState.currentEmail = email;
    el('roleChangeEmail').textContent = email;

    document.querySelectorAll('input[name="roleChange"]').forEach(radio => {
      radio.checked = radio.value === currentRole;
    });

    el('roleChangeModal').classList.remove('hidden');
  };

  el('roleChangeCancel')?.addEventListener('click', () => {
    el('roleChangeModal').classList.add('hidden');
    backofficeState.currentEmail = null;
  });

  el('roleChangeConfirm')?.addEventListener('click', async () => {
    const selectedRole = document.querySelector('input[name="roleChange"]:checked')?.value;
    if (!selectedRole || !backofficeState.currentEmail) return;

    try {
      const response = await fetchWithAuth(`/api/backoffice/users/${encodeURIComponent(backofficeState.currentEmail)}/role`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ role: selectedRole })
      });

      if (!response.ok) {
        if (response.status === 401 || response.status === 403) {
          showNotification('Access denied. Please log in again.', 'error');
          setTimeout(() => initializePage(), 2000);
          return;
        }
        throw new Error('Failed to update role');
      }

      el('roleChangeModal').classList.add('hidden');

      const roleToTabMap = {
        'Executive': ['Executive', 'executive'],
        'Sales': ['Sales', 'sales'],
        'Customer': ['Customer', 'customer'],
        'NoRole': null
      };

      const mapping = roleToTabMap[selectedRole];
      if (mapping) {
        loadRoleTabUsers(mapping[0], mapping[1], 1);
      } else {
        const currentTab = backofficeState.currentTab;
        if (currentTab === 'executives') loadRoleTabUsers('Executive', 'executive', backofficeState.tabPages.executives);
        else if (currentTab === 'sales') loadRoleTabUsers('Sales', 'sales', backofficeState.tabPages.sales);
        else if (currentTab === 'customers') loadRoleTabUsers('Customer', 'customer', backofficeState.tabPages.customers);
      }

      showNotification('Role updated successfully');
    } catch (error) {
      console.error('Failed to update role:', error);
      showNotification('Failed to update role', 'error');
    }

    backofficeState.currentEmail = null;
  });

  el('roleChangeModal')?.addEventListener('click', (e) => {
    if (e.target.id === 'roleChangeModal') {
      el('roleChangeModal').classList.add('hidden');
      backofficeState.currentEmail = null;
    }
  });

  // ========== INITIALIZE ==========

  initializePage();
</script>
</body>
</html>
