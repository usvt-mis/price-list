<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Backoffice Admin</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üîê</text></svg>"/>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-6xl mx-auto p-6 space-y-6">

    <!-- Backoffice Login View -->
    <div id="backofficeLoginView">
      <div class="flex items-center justify-center min-h-[60vh]">
        <div class="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full mx-4">
          <!-- Logo/Icon -->
          <div class="text-center mb-6">
            <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
              </svg>
            </div>
            <h1 class="text-2xl font-bold text-slate-900">Backoffice Admin</h1>
            <p class="text-sm text-slate-500 mt-1">Sign in to manage user roles</p>
          </div>

          <!-- Login Form -->
          <form id="backofficeLoginForm" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">Username</label>
              <input id="backofficeUsername" type="text" required
                class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                placeholder="Enter your username">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">Password</label>
              <input id="backofficePassword" type="password" required
                class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                placeholder="Enter your password">
            </div>
            <div id="backofficeLoginError" class="hidden text-sm text-red-600 bg-red-50 rounded-lg p-3"></div>
            <button type="submit" id="backofficeLoginSubmitBtn"
              class="w-full px-4 py-3 rounded-lg bg-purple-600 text-white font-medium hover:bg-purple-700 transition-colors flex items-center justify-center gap-2">
              <span>Sign In</span>
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- Backoffice Dashboard View (hidden by default) -->
    <div id="backofficeDashboardView" class="hidden">
      <div class="bg-white rounded-2xl shadow p-6">
        <div class="flex items-center justify-between mb-6">
          <div>
            <h1 class="text-2xl font-bold text-slate-900">Backoffice Dashboard</h1>
            <p class="text-sm text-slate-500">Manage user role assignments</p>
          </div>
          <div class="flex items-center gap-3">
            <span id="backofficeAdminName" class="text-sm text-slate-600"></span>
            <button id="backofficeLogoutBtn" class="px-4 py-2 text-sm rounded-lg border border-slate-200 hover:bg-slate-50 transition-colors">
              Logout
            </button>
          </div>
        </div>

        <!-- Tabs -->
        <div class="flex items-center gap-1 bg-slate-100 rounded-lg p-1 mb-6">
          <button onclick="showBackofficeTab('users')" id="backofficeTabUsers" class="px-4 py-2 text-sm font-medium rounded-md transition-colors">
            User Management
          </button>
          <button onclick="showBackofficeTab('audit')" id="backofficeTabAudit" class="px-4 py-2 text-sm font-medium rounded-md transition-colors">
            Audit Log
          </button>
        </div>

        <!-- User Management Tab -->
        <div id="backofficeUsersTab" class="hidden">
          <!-- Search and Filters -->
          <div class="flex flex-col sm:flex-row gap-4 mb-6">
            <div class="flex-1">
              <input id="backofficeUserSearch" type="text" placeholder="Search by email..."
                class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
            </div>
            <button id="backofficeSearchBtn" class="px-4 py-2 rounded-lg bg-slate-900 text-white text-sm hover:bg-slate-800 transition-colors">
              Search
            </button>
          </div>

          <!-- Users Table -->
          <div class="border border-slate-200 rounded-lg overflow-hidden">
            <table class="w-full text-sm">
              <thead class="bg-slate-50 text-slate-600">
                <tr>
                  <th class="text-left px-4 py-3 font-medium">Email</th>
                  <th class="text-left px-4 py-3 font-medium">Current Role</th>
                  <th class="text-left px-4 py-3 font-medium">Assigned By</th>
                  <th class="text-left px-4 py-3 font-medium">Assigned At</th>
                  <th class="text-left px-4 py-3 font-medium">Actions</th>
                </tr>
              </thead>
              <tbody id="backofficeUsersList" class="divide-y divide-slate-100">
                <tr>
                  <td colspan="5" class="px-4 py-8 text-center text-slate-500">Loading users...</td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          <div id="backofficePagination" class="flex items-center justify-between mt-4">
            <span id="backofficePaginationInfo" class="text-sm text-slate-600"></span>
            <div class="flex items-center gap-2">
              <button id="backofficePrevPage" class="px-3 py-1 rounded border border-slate-200 text-sm hover:bg-slate-50 disabled:opacity-50" disabled>
                Previous
              </button>
              <button id="backofficeNextPage" class="px-3 py-1 rounded border border-slate-200 text-sm hover:bg-slate-50 disabled:opacity-50" disabled>
                Next
              </button>
            </div>
          </div>
        </div>

        <!-- Audit Log Tab -->
        <div id="backofficeAuditTab" class="hidden">
          <div class="border border-slate-200 rounded-lg overflow-hidden">
            <table class="w-full text-sm">
              <thead class="bg-slate-50 text-slate-600">
                <tr>
                  <th class="text-left px-4 py-3 font-medium">Target Email</th>
                  <th class="text-left px-4 py-3 font-medium">Old Role</th>
                  <th class="text-left px-4 py-3 font-medium">New Role</th>
                  <th class="text-left px-4 py-3 font-medium">Changed By</th>
                  <th class="text-left px-4 py-3 font-medium">Changed At</th>
                </tr>
              </thead>
              <tbody id="backofficeAuditList" class="divide-y divide-slate-100">
                <tr>
                  <td colspan="5" class="px-4 py-8 text-center text-slate-500">Loading audit log...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Role Change Modal (hidden by default) -->
    <div id="roleChangeModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 backdrop-blur-sm">
      <div class="bg-white rounded-2xl shadow-xl p-6 max-w-sm w-full mx-4">
        <h3 class="text-xl font-bold text-slate-900 mb-4">Change Role</h3>
        <p class="text-sm text-slate-600 mb-4">Select new role for <strong id="roleChangeEmail"></strong>:</p>

        <div class="space-y-3 mb-6">
          <label class="flex items-center gap-3 p-3 rounded-lg border border-slate-200 hover:bg-slate-50 cursor-pointer">
            <input type="radio" name="roleChange" value="NoRole" class="text-purple-600">
            <div>
              <div class="font-medium text-slate-900">Unassigned</div>
              <div class="text-xs text-slate-500">No access to calculator</div>
            </div>
          </label>
          <label class="flex items-center gap-3 p-3 rounded-lg border border-slate-200 hover:bg-slate-50 cursor-pointer">
            <input type="radio" name="roleChange" value="Sales" class="text-blue-600">
            <div>
              <div class="font-medium text-slate-900">Sales</div>
              <div class="text-xs text-slate-500">Can view and save calculations</div>
            </div>
          </label>
          <label class="flex items-center gap-3 p-3 rounded-lg border border-slate-200 hover:bg-slate-50 cursor-pointer">
            <input type="radio" name="roleChange" value="Executive" class="text-emerald-600">
            <div>
              <div class="font-medium text-slate-900">Executive</div>
              <div class="text-xs text-slate-500">Full access including admin features</div>
            </div>
          </label>
        </div>

        <div class="flex gap-3">
          <button id="roleChangeCancel" class="flex-1 px-4 py-2 rounded-lg border border-slate-200 text-slate-700 hover:bg-slate-50 transition-colors">
            Cancel
          </button>
          <button id="roleChangeConfirm" class="flex-1 px-4 py-2 rounded-lg bg-purple-600 text-white hover:bg-purple-700 transition-colors">
            Change Role
          </button>
        </div>
      </div>
    </div>

    <!-- Notification Toast (hidden by default) -->
    <div id="notificationToast" class="hidden fixed bottom-6 right-6 z-50 px-6 py-4 rounded-lg shadow-lg text-sm font-medium transition-all transform">
      <span id="notificationMessage"></span>
    </div>

  </div>

<script>
  // ---------- Utility Functions ----------

  // Helper to get element by ID
  function el(id) {
    return document.getElementById(id);
  }

  // Show notification toast
  function showNotification(message, type = 'success') {
    const toast = el('notificationToast');
    const messageEl = el('notificationMessage');

    messageEl.textContent = message;

    // Set styles based on type
    toast.className = `fixed bottom-6 right-6 z-50 px-6 py-4 rounded-lg shadow-lg text-sm font-medium transition-all transform ${
      type === 'success'
        ? 'bg-emerald-600 text-white'
        : type === 'error'
        ? 'bg-red-600 text-white'
        : 'bg-slate-800 text-white'
    }`;

    toast.classList.remove('hidden');

    // Auto-hide after 3 seconds
    setTimeout(() => {
      toast.classList.add('hidden');
    }, 3000);
  }

  // Show view helper
  function showView(view) {
    // Hide all views
    el('backofficeLoginView').classList.add('hidden');
    el('backofficeDashboardView').classList.add('hidden');

    // Show requested view
    if (view === 'backoffice-login') {
      el('backofficeLoginView').classList.remove('hidden');
    } else if (view === 'backoffice-dashboard') {
      el('backofficeDashboardView').classList.remove('hidden');
    }
  }

  // ---------- Backoffice Auth and Dashboard ----------

  // Backoffice auth state
  let backofficeState = {
    isAuthenticated: false,
    admin: null,
    token: null,
    tokenExpiresAt: null,
    currentTab: 'users',
    currentPage: 1,
    pageSize: 50,
    totalPages: 0,
    currentEmail: null,
    lastActivity: Date.now(),
    idleCheckInterval: null
  };

  // Session timeout duration (8 hours of inactivity - matches token expiry)
  const IDLE_TIMEOUT = 8 * 60 * 60 * 1000;

  // Reset activity timer on user interaction
  function resetActivityTimer() {
    if (backofficeState.isAuthenticated) {
      backofficeState.lastActivity = Date.now();
    }
  }

  // Track user activity for idle timeout
  document.addEventListener('click', resetActivityTimer);
  document.addEventListener('keypress', resetActivityTimer);
  document.addEventListener('scroll', resetActivityTimer);
  document.addEventListener('touchstart', resetActivityTimer);

  // Check for idle timeout
  function checkIdleTimeout() {
    if (!backofficeState.isAuthenticated) return;

    const inactiveTime = Date.now() - backofficeState.lastActivity;
    if (inactiveTime > IDLE_TIMEOUT) {
      // Session expired due to inactivity
      backofficeLogout();
      showNotification('Session expired due to inactivity');
    }
  }

  // Start idle timeout check
  function startIdleTimeoutCheck() {
    if (backofficeState.idleCheckInterval) {
      clearInterval(backofficeState.idleCheckInterval);
    }
    backofficeState.idleCheckInterval = setInterval(checkIdleTimeout, 60000); // Check every minute
  }

  // Stop idle timeout check
  function stopIdleTimeoutCheck() {
    if (backofficeState.idleCheckInterval) {
      clearInterval(backofficeState.idleCheckInterval);
      backofficeState.idleCheckInterval = null;
    }
  }

  // Check for backoffice session on page load
  function checkBackofficeSession() {
    const token = sessionStorage.getItem('backofficeToken');
    const admin = JSON.parse(sessionStorage.getItem('backofficeAdmin') || 'null');
    const tokenExpiresAt = sessionStorage.getItem('backofficeTokenExpiresAt');

    // Add diagnostic logging
    console.log('[BACKOFFICE SESSION] Checking session:', {
      hasToken: !!token,
      hasAdmin: !!admin,
      hasExpiry: !!tokenExpiresAt,
      expiryDate: tokenExpiresAt ? new Date(tokenExpiresAt).toISOString() : null,
      isExpired: tokenExpiresAt ? Date.now() >= new Date(tokenExpiresAt).getTime() : null,
      currentTime: new Date().toISOString()
    });

    if (token && admin && tokenExpiresAt) {
      // Check if token has expired
      const expiryDate = new Date(tokenExpiresAt);
      const currentTime = Date.now();

      if (currentTime < expiryDate.getTime()) {
        // Token is still valid
        backofficeState.isAuthenticated = true;
        backofficeState.admin = admin;
        backofficeState.token = token;
        backofficeState.tokenExpiresAt = expiryDate;
        backofficeState.lastActivity = currentTime;
        startIdleTimeoutCheck();
        console.log('[BACKOFFICE SESSION] Session is valid');
        return true;
      } else {
        // Token expired - clear sessionStorage
        console.log('[BACKOFFICE SESSION] Token expired, clearing session');
        sessionStorage.removeItem('backofficeToken');
        sessionStorage.removeItem('backofficeAdmin');
        sessionStorage.removeItem('backofficeTokenExpiresAt');
      }
    }

    console.log('[BACKOFFICE SESSION] No valid session found');
    return false;
  }

  // Check if token is still valid (lightweight check without backend call)
  function isTokenValid() {
    if (!backofficeState.tokenExpiresAt) {
      console.log('[BACKOFFICE TOKEN] No expiry date set');
      return false;
    }
    const isValid = Date.now() < new Date(backofficeState.tokenExpiresAt).getTime();
    console.log('[BACKOFFICE TOKEN] Token validity check:', {
      expiresAt: backofficeState.tokenExpiresAt.toISOString(),
      currentTime: new Date().toISOString(),
      isValid: isValid
    });
    return isValid;
  }

  // Backoffice login form handler
  el('backofficeLoginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const username = el('backofficeUsername').value.trim();
    const password = el('backofficePassword').value;
    const errorEl = el('backofficeLoginError');
    const submitBtn = el('backofficeLoginSubmitBtn');

    // Clear previous error
    errorEl.classList.add('hidden');

    // Disable submit button
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="animate-spin">‚åõ</span> Signing in...';

    try {
      const response = await fetch('/api/backoffice/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });

      const data = await response.json();

      if (response.ok) {
        // Store session
        backofficeState.isAuthenticated = true;
        backofficeState.admin = data.admin;
        backofficeState.token = data.accessToken;
        backofficeState.tokenExpiresAt = new Date(Date.now() + data.expiresIn * 1000);
        backofficeState.lastActivity = Date.now();

        sessionStorage.setItem('backofficeToken', data.accessToken);
        sessionStorage.setItem('backofficeAdmin', JSON.stringify(data.admin));
        sessionStorage.setItem('backofficeTokenExpiresAt', backofficeState.tokenExpiresAt.toISOString());

        // Start idle timeout check
        startIdleTimeoutCheck();

        // Navigate to dashboard - let hash change handler handle navigation
        // This prevents race condition from double dashboard call
        window.location.hash = '#dashboard';
      } else {
        // Show error
        errorEl.textContent = data.error || 'Login failed';
        errorEl.classList.remove('hidden');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<span>Sign In</span>';
      }
    } catch (error) {
      console.error('Backoffice login error:', error);
      errorEl.textContent = 'Network error. Please try again.';
      errorEl.classList.remove('hidden');
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<span>Sign In</span>';
    }
  });

  // Backoffice logout handler
  async function backofficeLogout() {
    try {
      await fetch('/api/backoffice/logout', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${backofficeState.token}`
        }
      });
    } catch (e) {
      console.error('Logout error:', e);
    }

    // Stop idle timeout check
    stopIdleTimeoutCheck();

    // Clear session
    sessionStorage.removeItem('backofficeToken');
    sessionStorage.removeItem('backofficeAdmin');
    sessionStorage.removeItem('backofficeTokenExpiresAt');
    backofficeState = {
      isAuthenticated: false,
      admin: null,
      token: null,
      tokenExpiresAt: null,
      currentTab: 'users',
      currentPage: 1,
      pageSize: 50,
      totalPages: 0,
      currentEmail: null,
      lastActivity: Date.now(),
      idleCheckInterval: null
    };

    // Reset login button state (if showing login form)
    const submitBtn = el('backofficeLoginSubmitBtn');
    if (submitBtn) {
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<span>Sign In</span>';
    }

    // Navigate to login
    window.location.hash = '#login';
    showView('backoffice-login');
  }

  el('backofficeLogoutBtn').addEventListener('click', backofficeLogout);

  // Show backoffice dashboard
  function showBackofficeDashboard() {
    if (!backofficeState.isAuthenticated) {
      showView('backoffice-login');
      return;
    }

    // Update admin name
    if (el('backofficeAdminName')) {
      el('backofficeAdminName').textContent = `Logged in as ${backofficeState.admin.username}`;
    }

    showView('backoffice-dashboard');
    showBackofficeTab('users');
  }

  // Show backoffice tab (users or audit)
  window.showBackofficeTab = function(tab) {
    backofficeState.currentTab = tab;

    // Update tab buttons
    el('backofficeTabUsers').classList.remove('bg-white', 'shadow-sm', 'text-purple-600');
    el('backofficeTabUsers').classList.add('text-slate-600', 'hover:text-slate-900');
    el('backofficeTabAudit').classList.remove('bg-white', 'shadow-sm', 'text-purple-600');
    el('backofficeTabAudit').classList.add('text-slate-600', 'hover:text-slate-900');

    // Hide all tabs
    el('backofficeUsersTab').classList.add('hidden');
    el('backofficeAuditTab').classList.add('hidden');

    if (tab === 'users') {
      el('backofficeTabUsers').classList.add('bg-white', 'shadow-sm', 'text-purple-600');
      el('backofficeTabUsers').classList.remove('text-slate-600', 'hover:text-slate-900');
      el('backofficeUsersTab').classList.remove('hidden');
      loadBackofficeUsers();
    } else if (tab === 'audit') {
      el('backofficeTabAudit').classList.add('bg-white', 'shadow-sm', 'text-purple-600');
      el('backofficeTabAudit').classList.remove('text-slate-600', 'hover:text-slate-900');
      el('backofficeAuditTab').classList.remove('hidden');
      loadBackofficeAuditLog();
    }
  };

  // Load backoffice users list
  async function loadBackofficeUsers(page = 1) {
    // Add token validation check at start
    if (!isTokenValid()) {
      console.log('[BACKOFFICE USERS] Token invalid, logging out');
      backofficeLogout();
      showNotification('Session expired. Please log in again.');
      return;
    }

    const search = el('backofficeUserSearch')?.value || '';
    const pageSize = backofficeState.pageSize;
    const offset = (page - 1) * pageSize;

    try {
      const url = new URL('/api/backoffice/users', window.location.origin);
      url.searchParams.set('page', page);
      url.searchParams.set('pageSize', pageSize);
      if (search) url.searchParams.set('search', search);

      const response = await fetch(url.toString(), {
        headers: {
          'Authorization': `Bearer ${backofficeState.token}`
        }
      });

      if (!response.ok) {
        if (response.status === 401) {
          // Session expired - reset button state before logout
          const submitBtn = el('backofficeLoginSubmitBtn');
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<span>Sign In</span>';
          }
          backofficeLogout();
          showNotification('Session expired. Please log in again.');
          return;
        }
        throw new Error('Failed to load users');
      }

      const data = await response.json();
      backofficeState.currentPage = page;
      backofficeState.totalPages = data.pagination.totalPages;

      renderBackofficeUsers(data.users);
      updateBackofficePagination(data.pagination);
    } catch (error) {
      console.error('Failed to load users:', error);
      el('backofficeUsersList').innerHTML = `
        <tr>
          <td colspan="5" class="px-4 py-8 text-center text-red-500">
            Failed to load users. ${error.message}
          </td>
        </tr>
      `;
    }
  }

  // Render backoffice users table
  function renderBackofficeUsers(users) {
    const container = el('backofficeUsersList');

    if (users.length === 0) {
      container.innerHTML = `
        <tr>
          <td colspan="5" class="px-4 py-8 text-center text-slate-500">
            No users found.
          </td>
        </tr>
      `;
      return;
    }

    container.innerHTML = users.map(user => `
      <tr class="hover:bg-slate-50">
        <td class="px-4 py-3">${user.email}</td>
        <td class="px-4 py-3">
          <span class="px-2 py-1 text-xs font-semibold rounded ${
            user.role === 'Executive' ? 'bg-emerald-100 text-emerald-700' :
            user.role === 'Sales' ? 'bg-blue-100 text-blue-700' :
            'bg-slate-100 text-slate-600'
          }">
            ${user.role === 'NoRole' ? 'Unassigned' : user.role}
          </span>
        </td>
        <td class="px-4 py-3 text-slate-600">${user.assignedBy || 'System'}</td>
        <td class="px-4 py-3 text-slate-600">${user.assignedAt ? new Date(user.assignedAt).toLocaleDateString() : '-'}</td>
        <td class="px-4 py-3">
          <button onclick="openRoleChangeModal('${user.email}', '${user.role}')" class="px-3 py-1 text-xs font-medium rounded border border-purple-200 text-purple-700 hover:bg-purple-50 transition-colors">
            Change Role
          </button>
        </td>
      </tr>
    `).join('');
  }

  // Update pagination UI
  function updateBackofficePagination(pagination) {
    el('backofficePaginationInfo').textContent = `Page ${pagination.page} of ${pagination.totalPages} (${pagination.total} total)`;
    el('backofficePrevPage').disabled = pagination.page <= 1;
    el('backofficeNextPage').disabled = pagination.page >= pagination.totalPages;
  }

  // Pagination handlers
  el('backofficePrevPage').addEventListener('click', () => {
    if (backofficeState.currentPage > 1) {
      loadBackofficeUsers(backofficeState.currentPage - 1);
    }
  });

  el('backofficeNextPage').addEventListener('click', () => {
    if (backofficeState.currentPage < backofficeState.totalPages) {
      loadBackofficeUsers(backofficeState.currentPage + 1);
    }
  });

  // Search handler
  el('backofficeSearchBtn').addEventListener('click', () => {
    loadBackofficeUsers(1);
  });

  el('backofficeUserSearch').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      loadBackofficeUsers(1);
    }
  });

  // Load audit log
  async function loadBackofficeAuditLog() {
    // Add token validation check at start
    if (!isTokenValid()) {
      console.log('[BACKOFFICE AUDIT] Token invalid, logging out');
      backofficeLogout();
      showNotification('Session expired. Please log in again.');
      return;
    }

    try {
      const response = await fetch('/api/backoffice/audit-log', {
        headers: {
          'Authorization': `Bearer ${backofficeState.token}`
        }
      });

      if (!response.ok) {
        throw new Error('Failed to load audit log');
      }

      const data = await response.json();
      renderBackofficeAuditLog(data.entries);
    } catch (error) {
      console.error('Failed to load audit log:', error);
      el('backofficeAuditList').innerHTML = `
        <tr>
          <td colspan="5" class="px-4 py-8 text-center text-red-500">
            Failed to load audit log. ${error.message}
          </td>
        </tr>
      `;
    }
  }

  // Render audit log
  function renderBackofficeAuditLog(entries) {
    const container = el('backofficeAuditList');

    if (entries.length === 0) {
      container.innerHTML = `
        <tr>
          <td colspan="5" class="px-4 py-8 text-center text-slate-500">
            No audit entries found.
          </td>
        </tr>
      `;
      return;
    }

    container.innerHTML = entries.map(entry => `
      <tr class="hover:bg-slate-50">
        <td class="px-4 py-3">${entry.targetEmail}</td>
        <td class="px-4 py-3">
          <span class="px-2 py-1 text-xs font-semibold rounded ${
            entry.oldRole === 'Executive' ? 'bg-emerald-100 text-emerald-700' :
            entry.oldRole === 'Sales' ? 'bg-blue-100 text-blue-700' :
            'bg-slate-100 text-slate-600'
          }">
            ${entry.oldRole === 'NoRole' ? 'Unassigned' : entry.oldRole}
          </span>
        </td>
        <td class="px-4 py-3">
          <span class="px-2 py-1 text-xs font-semibold rounded ${
            entry.newRole === 'Executive' ? 'bg-emerald-100 text-emerald-700' :
            entry.newRole === 'Sales' ? 'bg-blue-100 text-blue-700' :
            'bg-slate-100 text-slate-600'
          }">
            ${entry.newRole === 'NoRole' ? 'Unassigned' : entry.newRole}
          </span>
        </td>
        <td class="px-4 py-3 text-slate-600">${entry.changedBy}</td>
        <td class="px-4 py-3 text-slate-600">${new Date(entry.changedAt).toLocaleString()}</td>
      </tr>
    `).join('');
  }

  // Role change modal
  window.openRoleChangeModal = function(email, currentRole) {
    backofficeState.currentEmail = email;
    el('roleChangeEmail').textContent = email;

    // Set current role as selected
    document.querySelectorAll('input[name="roleChange"]').forEach(radio => {
      radio.checked = radio.value === currentRole;
    });

    el('roleChangeModal').classList.remove('hidden');
  };

  el('roleChangeCancel').addEventListener('click', () => {
    el('roleChangeModal').classList.add('hidden');
    backofficeState.currentEmail = null;
  });

  el('roleChangeConfirm').addEventListener('click', async () => {
    const selectedRole = document.querySelector('input[name="roleChange"]:checked')?.value;
    if (!selectedRole || !backofficeState.currentEmail) return;

    // Add token validation check before API call
    if (!isTokenValid()) {
      console.log('[BACKOFFICE ROLE CHANGE] Token invalid, logging out');
      backofficeLogout();
      showNotification('Session expired. Please log in again.');
      return;
    }

    try {
      const response = await fetch(`/api/backoffice/users/${encodeURIComponent(backofficeState.currentEmail)}/role`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${backofficeState.token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ role: selectedRole })
      });

      if (!response.ok) {
        throw new Error('Failed to update role');
      }

      // Close modal and refresh list
      el('roleChangeModal').classList.add('hidden');
      loadBackofficeUsers(backofficeState.currentPage);
      showNotification('Role updated successfully');
    } catch (error) {
      console.error('Failed to update role:', error);
      showNotification('Failed to update role', 'error');
    }

    backofficeState.currentEmail = null;
  });

  // Close modal on outside click
  el('roleChangeModal').addEventListener('click', (e) => {
    if (e.target.id === 'roleChangeModal') {
      el('roleChangeModal').classList.add('hidden');
      backofficeState.currentEmail = null;
    }
  });

  // Hash-based routing for backoffice
  function handleHashChange() {
    const hash = window.location.hash;

    if (hash === '#login' || hash === '' || hash === '#') {
      if (checkBackofficeSession()) {
        window.location.hash = '#dashboard';
      } else {
        showView('backoffice-login');
      }
    } else if (hash === '#dashboard') {
      if (checkBackofficeSession()) {
        showBackofficeDashboard();
      } else {
        window.location.hash = '#login';
      }
    }
  }

  // Listen for hash changes
  window.addEventListener('hashchange', handleHashChange);

  // Check hash on page load (after init)
  setTimeout(() => {
    handleHashChange();
  }, 100);
</script>
</body>
</html>
